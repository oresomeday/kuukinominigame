<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ - „Ç®„É≥„Éâ„É¨„Çπ„Éü„Éã„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #0a0a1a;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: linear-gradient(180deg, #6c0000, #8b0000);
            border: 2px solid #ff3030;
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(139,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .back-btn:active { transform: scale(0.9); }
        #game {
            width: 100vw;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            position: absolute;
            top: 0;
            left: 0;
        }
        .screen.active { display: flex; }
        #title {
            background: #000;
            position: relative;
            overflow: hidden;
        }
        .bg-effects {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }
        .cyber-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                linear-gradient(90deg, rgba(0,255,255,0.03) 1px, transparent 1px),
                linear-gradient(rgba(0,255,255,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: gridMove 20s linear infinite;
        }
        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 30px 30px; }
        }
        .aurora {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(100,0,200,0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(0,150,255,0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(0,50,150,0.4) 0%, transparent 50%);
            animation: auroraShift 8s ease-in-out infinite;
        }
        @keyframes auroraShift {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .particles {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            animation: floatUp 10s infinite;
            opacity: 0;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        .scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg, transparent 0px, transparent 2px,
                rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px
            );
        }
        .title-content {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 20px;
        }
        .title-logo {
            text-align: center;
            margin-bottom: auto;
            padding-top: 12vh;
        }
        .title-icon {
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            animation: iconFloat 3s ease-in-out infinite, iconGlow 2s ease-in-out infinite alternate;
        }
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 30px rgba(100,0,255,0.8)); }
            to { filter: drop-shadow(0 0 50px rgba(0,150,255,0.8)); }
        }
        .title-text {
            font-size: 2.2em;
            font-weight: 900;
            letter-spacing: 0.15em;
            color: #fff;
            text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 40px #6600ff, 0 0 80px #6600ff;
            animation: textPulse 2s ease-in-out infinite;
        }
        @keyframes textPulse {
            0%, 100% { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 40px #6600ff, 0 0 80px #6600ff; }
            50% { text-shadow: 0 0 20px #fff, 0 0 40px #fff, 0 0 60px #0099ff, 0 0 100px #0099ff; }
        }
        .title-sub {
            font-size: 0.85em;
            color: #88aaff;
            letter-spacing: 0.5em;
            margin-top: 10px;
            text-shadow: 0 0 20px #4488ff;
        }
        .title-desc {
            color: #aaa;
            font-size: 0.85em;
            margin-top: 15px;
            text-align: center;
            line-height: 1.6;
        }
        .title-desc span { color: #ff6688; font-weight: bold; }
        .title-clear-info {
            color: #4ecdc4;
            font-size: 0.8em;
            margin-top: 10px;
            padding: 8px 16px;
            background: rgba(78,205,196,0.1);
            border: 1px solid rgba(78,205,196,0.3);
            border-radius: 20px;
        }
        .start-btn-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .start-btn {
            position: relative;
            background: transparent;
            border: none;
            padding: 22px 70px;
            font-size: 1.6em;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            overflow: hidden;
            transition: all 0.3s;
        }
        .start-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, #6600ff, #0066ff, #00ccff, #6600ff);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            border-radius: 50px;
            z-index: -2;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .start-btn::after {
            content: '';
            position: absolute;
            inset: 3px;
            background: rgba(0,0,0,0.85);
            border-radius: 47px;
            z-index: -1;
            transition: background 0.3s;
        }
        .start-btn:hover::after, .start-btn:active::after { background: rgba(0,0,0,0.6); }
        .start-btn span { position: relative; z-index: 1; text-shadow: 0 0 20px #fff; }
        .start-btn:active { transform: scale(0.95); }
        .deco-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: auto;
            padding-bottom: 10vh;
        }
        .deco-line {
            width: 80px; height: 2px;
            background: linear-gradient(90deg, transparent, #6600ff, #00ccff, transparent);
            animation: lineGlow 2s infinite;
        }
        @keyframes lineGlow { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .deco-diamond {
            width: 12px; height: 12px;
            background: linear-gradient(45deg, #6600ff, #00ccff);
            transform: rotate(45deg);
            animation: diamondSpin 4s linear infinite;
            box-shadow: 0 0 15px #6600ff;
        }
        @keyframes diamondSpin { from { transform: rotate(45deg); } to { transform: rotate(405deg); } }
        .hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 8px 12px;
            padding-left: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            z-index: 10;
        }
        .hud-item { display: flex; align-items: center; gap: 5px; color: #fff; font-weight: bold; }
        .lives { font-size: 1.2em; }
        .fever-gauge {
            width: 80px; height: 12px;
            background: #333; border-radius: 6px;
            overflow: hidden; border: 2px solid #666;
        }
        .fever-fill {
            height: 100%;
            background: linear-gradient(90deg, #6600ff, #00ccff, #00ff88);
            background-size: 200% 100%;
            animation: feverGradient 1s linear infinite;
            transition: width 0.3s;
        }
        @keyframes feverGradient { 0% { background-position: 0% 0%; } 100% { background-position: 200% 0%; } }
        .score { color: #00ccff; font-size: 1.1em; text-shadow: 0 0 10px #00ccff; }
        .combo-display {
            position: absolute; top: 45px; right: 15px;
            color: #ffff00; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 15px #ffff00;
        }
        .round-display {
            position: absolute; top: 45px; left: 70px;
            color: #00ff88; font-size: 1em; font-weight: bold; text-shadow: 0 0 10px #00ff88;
        }
        .pass-display {
            position: absolute; top: 70px; left: 70px;
            color: #888; font-size: 0.9em; font-weight: bold;
        }
        .mini-type {
            position: absolute; top: 70px; right: 15px;
            color: #ff88cc; font-size: 0.8em; font-weight: bold; text-shadow: 0 0 10px #ff88cc;
        }
        .clear-goal {
            position: absolute; top: 95px; left: 70px;
            color: #4ecdc4; font-size: 0.75em; font-weight: bold;
            text-shadow: 0 0 8px #4ecdc4;
        }
        .timer-wrap {
            position: absolute; top: 40px; left: 0; right: 0;
            height: 8px; background: rgba(255,255,255,0.1);
        }
        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            transition: width 0.05s linear;
            box-shadow: 0 0 10px currentColor;
        }
        .timer-bar.warn { background: linear-gradient(90deg, #ffcc00, #ff9900); }
        .timer-bar.danger { background: linear-gradient(90deg, #ff0044, #ff0088); animation: timerPulse 0.2s infinite; }
        @keyframes timerPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        #gameplay { background: linear-gradient(180deg, #0a0a2e 0%, #1a0a2e 100%); }
        .game-area {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; padding-top: 55px; position: relative;
        }
        .fever-mode .game-area { animation: feverBg 0.3s infinite alternate; }
        @keyframes feverBg { from { background: rgba(100,0,255,0.15); } to { background: rgba(0,200,255,0.15); } }
        .round-splash {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em; font-weight: 900; color: #fff;
            text-shadow: 0 0 20px #fff, 0 0 40px #00ccff, 0 0 60px #00ccff;
            z-index: 100; animation: splashAnim 0.6s forwards;
            text-align: center; white-space: nowrap;
        }
        @keyframes splashAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(3) rotate(-10deg); }
            40% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }
        .popup {
            position: fixed; top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em; font-weight: bold;
            pointer-events: none; z-index: 1000;
            animation: popAnim 0.5s forwards;
        }
        @keyframes popAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }
        .popup.nice { color: #00ff88; text-shadow: 0 0 30px #00ff88; }
        .popup.great { color: #00ccff; text-shadow: 0 0 30px #00ccff; }
        .popup.perfect { color: #cc00ff; text-shadow: 0 0 30px #cc00ff; }
        .popup.combo { color: #ffff00; text-shadow: 0 0 30px #ffff00; }
        .popup.miss { color: #ff0044; text-shadow: 0 0 30px #ff0044; }
        .popup.pass { color: #888; text-shadow: 0 0 30px #888; }
        .popup.fever { color: #fff; text-shadow: 0 0 30px #6600ff, 0 0 60px #00ccff; font-size: 3em; }
        .flash { position: fixed; inset: 0; pointer-events: none; z-index: 999; }
        .flash.hit { animation: flashGreen 0.15s; }
        .flash.miss { animation: flashRed 0.15s; }
        .flash.pass { animation: flashGray 0.15s; }
        @keyframes flashGreen { from { background: rgba(0,255,100,0.4); } to { background: transparent; } }
        @keyframes flashRed { from { background: rgba(255,0,50,0.4); } to { background: transparent; } }
        @keyframes flashGray { from { background: rgba(128,128,128,0.3); } to { background: transparent; } }
        .game-btn {
            padding: 18px 40px; margin: 8px; font-size: 1.3em; font-weight: bold;
            border: none; border-radius: 15px; cursor: pointer;
            transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .game-btn:active { transform: scale(0.95); }
        .game-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-correct { background: linear-gradient(145deg, #00cc66, #009944); color: white; box-shadow: 0 5px 20px rgba(0,200,100,0.4); }
        .btn-wrong { background: linear-gradient(145deg, #ff4466, #cc2244); color: white; box-shadow: 0 5px 20px rgba(255,50,100,0.4); }
        .btn-pass { background: linear-gradient(145deg, #666, #444); color: #ddd; box-shadow: 0 5px 20px rgba(100,100,100,0.4); padding: 12px 30px; font-size: 1em; }
        .btn-pass:disabled { background: linear-gradient(145deg, #333, #222); color: #555; box-shadow: none; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .pass-container { margin-top: 30px; text-align: center; }
        .pass-remaining { color: #888; font-size: 0.9em; margin-top: 8px; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 320px; width: 100%; margin: 10px auto; }
        .char-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 1.8em; font-weight: 900; border-radius: 12px; cursor: pointer;
            transition: all 0.15s; color: #fff;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            border: 2px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .char-cell:active { transform: scale(0.9); }
        .char-cell.correct { border-color: #00ff88; background: linear-gradient(145deg, #003322, #002211); box-shadow: 0 0 20px rgba(0,255,100,0.4); animation: cellCorrect 0.3s; }
        @keyframes cellCorrect { 50% { transform: scale(1.15); } }
        .char-cell.wrong { border-color: #ff0044; background: linear-gradient(145deg, #330011, #220011); box-shadow: 0 0 20px rgba(255,0,50,0.4); animation: cellShake 0.3s; }
        @keyframes cellShake { 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .order-display { font-size: 1.2em; color: #aaa; margin-bottom: 10px; min-height: 30px; }
        .order-display .done { color: #00ff88; }
        .order-display .current { color: #ffff00; font-size: 1.3em; }
        .order-display .remaining { color: #555; }
        .bubble-area { position: relative; width: 100%; height: 300px; overflow: hidden; }
        .bubble {
            position: absolute; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: 900; cursor: pointer;
            transition: transform 0.1s; animation: bubbleFloat 3s ease-in-out infinite;
            color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .bubble:active { transform: scale(0.85); }
        @keyframes bubbleFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .bubble.pop { animation: bubblePop 0.3s forwards !important; }
        @keyframes bubblePop { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.5; } 100% { transform: scale(0); opacity: 0; } }
        .fall-area { position: relative; width: 100%; height: 350px; overflow: hidden; border-radius: 15px; background: rgba(0,0,0,0.3); }
        .fall-char {
            position: absolute; font-size: 2em; font-weight: 900; cursor: pointer;
            color: #fff; text-shadow: 0 0 15px currentColor; animation: falling linear forwards;
        }
        @keyframes falling { from { top: -50px; } to { top: 360px; } }
        .fall-char:active { transform: scale(0.8); }
        .fall-char.caught { animation: caughtAnim 0.3s forwards !important; }
        @keyframes caughtAnim { to { transform: scale(2); opacity: 0; } }
        .swipe-card {
            width: 250px; height: 180px;
            background: linear-gradient(145deg, #2a2a6a, #1a1a4a);
            border: 3px solid #4444aa; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 3em; font-weight: 900; color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: transform 0.1s; cursor: grab;
        }
        .swipe-card .card-label { font-size: 0.3em; color: #888; margin-top: 10px; }
        .swipe-hint { display: flex; justify-content: space-between; width: 280px; margin-top: 20px; color: #666; font-size: 0.9em; }
        .swipe-hint .left-hint { color: #ff4466; }
        .swipe-hint .right-hint { color: #00cc66; }
        .quiz-choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 320px; width: 100%; margin-top: 15px; }
        .quiz-choice {
            padding: 15px 10px; font-size: 1.2em; font-weight: bold;
            border: 2px solid #444; border-radius: 12px;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            color: #fff; cursor: pointer; transition: all 0.15s; text-align: center;
        }
        .quiz-choice:active { transform: scale(0.95); }
        .quiz-choice.correct-answer { border-color: #00ff88; background: linear-gradient(145deg, #003322, #002211); }
        .quiz-choice.wrong-answer { border-color: #ff0044; background: linear-gradient(145deg, #330011, #220011); }
        .fill-word { font-size: 2.5em; font-weight: 900; color: #fff; letter-spacing: 0.2em; margin: 20px 0; }
        .fill-word .blank {
            display: inline-block; width: 50px; height: 50px;
            border-bottom: 4px solid #00ccff; margin: 0 3px;
            text-align: center; color: #00ccff; animation: blinkCursor 1s infinite;
        }
        @keyframes blinkCursor { 0%, 100% { border-color: #00ccff; } 50% { border-color: transparent; } }
        .fill-word .blank.filled { border-color: #00ff88; color: #00ff88; animation: none; }
        .fill-choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .fill-choice {
            width: 55px; height: 55px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: 900; border: 2px solid #444; border-radius: 10px;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a); color: #fff; cursor: pointer; transition: all 0.15s;
        }
        .fill-choice:active { transform: scale(0.9); }
        .fill-choice.used { opacity: 0.3; pointer-events: none; }
        .memory-display {
            font-size: 3em; font-weight: 900; color: #fff;
            text-shadow: 0 0 30px #6600ff; letter-spacing: 0.2em;
            margin: 20px 0; min-height: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        .memory-display.show { animation: memoryFlash 0.5s; }
        @keyframes memoryFlash { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .memory-display.hide { color: transparent; text-shadow: none; }
        .memory-display.hide::after { content: 'ÔºüÔºüÔºüÔºüÔºü'; color: #444; font-size: 0.8em; }
        .reflex-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 320px; }
        .reflex-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 2em; font-weight: 900; border-radius: 15px; cursor: pointer; color: #fff;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a); border: 2px solid #444; transition: all 0.15s;
        }
        .reflex-cell:active { transform: scale(0.9); }
        .reflex-cell.lit { background: linear-gradient(145deg, #003366, #004488); border-color: #00ccff; box-shadow: 0 0 25px rgba(0,200,255,0.5); }
        .question-text { color: #ccc; font-size: 1.1em; text-align: center; margin-bottom: 15px; line-height: 1.5; }
        .question-text em { color: #ffcc00; font-style: normal; font-weight: bold; }
        .question-text .highlight { color: #00ccff; font-weight: bold; font-size: 1.3em; }
        .mini-label { color: #ff88cc; font-size: 0.85em; font-weight: bold; margin-bottom: 8px; letter-spacing: 0.2em; }
        .mole-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; max-width: 300px; width: 100%; margin: 10px auto;
        }
        .mole-hole {
            aspect-ratio: 1; border-radius: 50%;
            background: radial-gradient(circle, #1a1a3a, #0a0a1a);
            border: 3px solid #333; display: flex; align-items: center; justify-content: center;
            font-size: 2em; font-weight: 900; cursor: pointer;
            transition: all 0.15s; overflow: hidden; position: relative;
        }
        .mole-hole .mole-char {
            position: absolute; bottom: -100%; transition: bottom 0.2s;
            color: #fff; text-shadow: 0 0 10px currentColor;
        }
        .mole-hole.active .mole-char { bottom: 15%; }
        .mole-hole.active { border-color: #00ccff; box-shadow: 0 0 20px rgba(0,200,255,0.3); }
        .mole-hole:active { transform: scale(0.9); }
        .slot-container { display: flex; gap: 8px; margin: 20px 0; }
        .slot-reel {
            width: 60px; height: 80px;
            background: linear-gradient(145deg, #1a1a3a, #0a0a2a);
            border: 3px solid #444; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2em; font-weight: 900; color: #fff;
            overflow: hidden; position: relative;
        }
        .slot-reel.spinning { animation: slotSpin 0.1s infinite; }
        @keyframes slotSpin { 0% { color: rgba(255,255,255,1); } 50% { color: rgba(255,255,255,0.3); } 100% { color: rgba(255,255,255,1); } }
        .slot-reel.stopped { border-color: #00ff88; box-shadow: 0 0 15px rgba(0,255,100,0.3); }
        .slot-reel.wrong-stop { border-color: #ff0044; box-shadow: 0 0 15px rgba(255,0,50,0.3); }
        .count-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; max-width: 340px; margin: 15px 0; }
        .count-char {
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4em; font-weight: 900; color: #fff;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            border: 2px solid #444; border-radius: 8px;
        }
        .count-choices { display: flex; gap: 10px; margin-top: 15px; }
        .count-choice {
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: bold; border: 2px solid #444; border-radius: 12px;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            color: #fff; cursor: pointer; transition: all 0.15s;
        }
        .count-choice:active { transform: scale(0.9); }
        .typing-display {
            font-size: 2.8em; font-weight: 900; color: #fff;
            letter-spacing: 0.15em; margin: 15px 0;
            text-shadow: 0 0 20px #6600ff;
        }
        .typing-display .typed { color: #00ff88; text-shadow: 0 0 15px #00ff88; }
        .typing-display .cursor-char { color: #ffff00; text-shadow: 0 0 20px #ffff00; animation: blinkCursor 0.5s infinite; border-bottom: 3px solid #ffff00; }
        .typing-display .untyped { color: #444; }
        .typing-keys { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; max-width: 340px; margin-top: 15px; }
        .typing-key {
            width: 52px; height: 52px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4em; font-weight: 900; border: 2px solid #444; border-radius: 10px;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            color: #fff; cursor: pointer; transition: all 0.1s;
        }
        .typing-key:active { transform: scale(0.85); background: linear-gradient(145deg, #003366, #002244); }
        .mirror-text { font-size: 2.5em; font-weight: 900; color: #fff; letter-spacing: 0.2em; margin: 20px 0; text-shadow: 0 0 25px #cc00ff; }
        .chain-display { display: flex; gap: 3px; margin: 15px 0; flex-wrap: wrap; justify-content: center; }
        .chain-char {
            width: 42px; height: 48px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: 900; color: #fff;
            background: linear-gradient(145deg, #2a2a5a, #1a1a3a);
            border: 2px solid #444; border-radius: 8px; cursor: pointer; transition: all 0.15s;
        }
        .chain-char:active { transform: scale(0.9); }
        .chain-char.found { border-color: #00ff88; background: linear-gradient(145deg, #003322, #002211); box-shadow: 0 0 10px rgba(0,255,100,0.3); }
        .tap-counter { font-size: 4em; font-weight: 900; color: #00ccff; text-shadow: 0 0 30px #00ccff; margin: 10px 0; font-family: 'Courier New', monospace; }
        .tap-target-btn {
            width: 150px; height: 150px; border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #4400cc, #220066);
            border: 4px solid #6600ff; color: #fff;
            font-size: 2.5em; font-weight: 900; cursor: pointer;
            box-shadow: 0 0 30px rgba(100,0,255,0.5);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.05s;
        }
        .tap-target-btn:active { transform: scale(0.92); box-shadow: 0 0 50px rgba(100,0,255,0.8); }

        /* ========== ÁµêÊûúÁîªÈù¢ ========== */
        #result { position: relative; overflow: hidden; }
        #result.lose-bg { background: radial-gradient(ellipse at center, #1a1a3a 0%, #0a0a1a 100%); }
        #result.clear-bg { background: radial-gradient(ellipse at center, #0a2a2a 0%, #0a1a2a 100%); }
        #result .result-aurora {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            animation: loseAurora 3s ease-in-out infinite alternate;
        }
        .result-aurora.lose-aurora {
            background:
                radial-gradient(ellipse at 30% 30%, rgba(100,0,200,0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 70%, rgba(0,150,255,0.2) 0%, transparent 50%);
        }
        .result-aurora.clear-aurora {
            background:
                radial-gradient(ellipse at 30% 30%, rgba(0,200,150,0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 70%, rgba(0,200,255,0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255,215,0,0.2) 0%, transparent 50%);
        }
        @keyframes loseAurora { from { opacity: 0.5; } to { opacity: 1; } }
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 1; }
        .confetti { position: absolute; top: -20px; animation: confettiFall linear infinite; }
        @keyframes confettiFall { 0% { transform: translateY(-20px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(1080deg); opacity: 0.8; } }
        .stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .star { position: absolute; font-size: 1.5em; animation: starTwinkle 1s ease-out forwards; }
        @keyframes starTwinkle { 0% { transform: scale(0) rotate(0deg); opacity: 1; } 50% { transform: scale(1.5) rotate(180deg); } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        .result-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .result-icon-container { position: relative; margin-bottom: 20px; }
        .result-icon { font-size: 5em; animation: iconEntry 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); filter: drop-shadow(0 0 30px currentColor); }
        @keyframes iconEntry { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .icon-ring { position: absolute; top: 50%; left: 50%; width: 150px; height: 150px; border: 3px solid rgba(0,200,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); animation: ringExpand 1.5s ease-out infinite; }
        .icon-ring.clear-ring { border-color: rgba(78,205,196,0.4); }
        @keyframes ringExpand { 0% { width: 100px; height: 100px; opacity: 1; } 100% { width: 250px; height: 250px; opacity: 0; } }
        .result-title { font-size: 2.2em; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 15px; }
        .result-title.title-lose { color: #ff6688; text-shadow: 0 0 20px #ff0044; }
        .result-title.title-clear { color: #4ecdc4; text-shadow: 0 0 20px #4ecdc4, 0 0 40px #4ecdc4; }
        .result-score-box {
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(30,30,60,0.6));
            border: 2px solid rgba(0,200,255,0.3); border-radius: 20px;
            padding: 20px 50px; margin: 15px 0; text-align: center;
            backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(0,200,255,0.2);
            animation: boxAppear 0.5s ease-out 0.3s both;
        }
        @keyframes boxAppear { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .result-score-label { color: #888; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.3em; margin-bottom: 8px; }
        .result-score-value { font-size: 3em; font-weight: 900; color: #00ccff; text-shadow: 0 0 30px #00ccff; font-family: 'Courier New', monospace; }
        .result-stats { background: rgba(0,0,0,0.4); border-radius: 15px; padding: 15px 25px; margin: 10px 0; border: 1px solid rgba(255,255,255,0.1); animation: boxAppear 0.5s ease-out 0.5s both; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; color: #fff; font-size: 1em; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 30px; }
        .stat-row:last-child { border-bottom: none; }
        .stat-value { font-weight: bold; text-shadow: 0 0 10px currentColor; }
        .stat-value.cyan { color: #00ccff; }
        .stat-value.gold { color: #ffd700; }
        .stat-value.pink { color: #cc00ff; }
        .stat-value.gray { color: #888; }
        .stat-value.green { color: #4ecdc4; }
        .result-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; animation: boxAppear 0.5s ease-out 0.7s both; }
        .btn {
            background: linear-gradient(145deg, #6600ff, #4400cc); color: white; border: none;
            padding: 16px 45px; font-size: 1.2em; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 30px rgba(100,0,255,0.5);
            transition: all 0.2s; position: relative; overflow: hidden;
            text-transform: uppercase; letter-spacing: 0.1em;
        }
        .btn::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); animation: btnShine 2s infinite; }
        @keyframes btnShine { 0% { left: -50%; } 100% { left: 150%; } }
        .btn:active { transform: scale(0.95); }
        .btn-cyan { background: linear-gradient(145deg, #0088cc, #006699); box-shadow: 0 5px 30px rgba(0,150,220,0.5); }
        .btn-green { background: linear-gradient(145deg, #2cb5ac, #1a8a82); box-shadow: 0 5px 30px rgba(78,205,196,0.5); }
        .btn-small { padding: 12px 30px; font-size: 1em; }
        .highscore-badge { background: linear-gradient(145deg, #ffd700, #ff8800); color: #000; padding: 8px 20px; border-radius: 30px; font-weight: bold; font-size: 1.1em; margin-bottom: 15px; animation: badgePop 0.5s ease-out 1s both; box-shadow: 0 0 30px rgba(255,215,0,0.5); }
        @keyframes badgePop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .clear-badge { background: linear-gradient(145deg, #4ecdc4, #2cb5ac); color: #fff; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 1.1em; margin-bottom: 15px; animation: badgePop 0.5s ease-out 0.5s both; box-shadow: 0 0 30px rgba(78,205,196,0.5); }
        .redirect-msg { color: #4ecdc4; font-size: 0.85em; margin-top: 15px; animation: blinkSlow 1.5s infinite; }
        @keyframes blinkSlow { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <div id="game">
        <div class="flash" id="flash"></div>
        <div id="title" class="screen active">
            <div class="bg-effects">
                <div class="cyber-grid"></div>
                <div class="aurora"></div>
                <div class="particles" id="particles"></div>
                <div class="scanlines"></div>
            </div>
            <div class="title-content">
                <div class="title-logo">
                    <span class="title-icon">ü´ß</span>
                    <div class="title-text">„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</div>
                    <div class="title-sub">ENDLESS MINIGAMES</div>
                    <div class="title-desc">
                        „Äå<span>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</span>„Äç„Å´„Åæ„Å§„Çè„Çã<br>
                        20Á®Æ„ÅÆ„Éü„Éã„Ç≤„Éº„É†„ÅåÊ¨°„ÄÖÁôªÂ†¥ÔºÅ<br>
                        „Å©„Åì„Åæ„ÅßÁîü„ÅçÊÆã„Çå„Çã„ÅãÊåëÊà¶„Åó„Çà„ÅÜ
                    </div>
                    <div class="title-clear-info">üéØ ROUND 15 Âà∞ÈÅî„Åß„ÇØ„É™„Ç¢ÔºÅ</div>
                </div>
                <div class="start-btn-wrap">
                    <button class="start-btn" onclick="startGame()">
                        <span>‚ñ∂ START</span>
                    </button>
                </div>
                <div style="color:#00ccff; font-size:1.2em; text-shadow:0 0 15px #00ccff;">
                    üèÜ BEST: <span id="best-score">0</span>
                </div>
                <div class="deco-container">
                    <div class="deco-line"></div>
                    <div class="deco-diamond"></div>
                    <div class="deco-line"></div>
                </div>
            </div>
        </div>
        <div id="gameplay" class="screen">
            <div class="hud">
                <div class="hud-item"><span class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
                <div class="hud-item">
                    <span style="font-size:0.8em;">üî•</span>
                    <div class="fever-gauge"><div class="fever-fill" id="fever-fill" style="width:0%"></div></div>
                </div>
                <div class="hud-item"><span class="score" id="score">0</span></div>
            </div>
            <div class="round-display" id="round-display">ROUND 1</div>
            <div class="pass-display" id="pass-display">‚è≠ <span id="pass-icons">‚ö™‚ö™‚ö™</span></div>
            <div class="clear-goal" id="clear-goal">üéØ „ÇØ„É™„Ç¢„Åæ„Åß: „ÅÇ„Å®15</div>
            <div class="mini-type" id="mini-type"></div>
            <div class="combo-display" id="combo"></div>
            <div class="timer-wrap"><div class="timer-bar" id="timer"></div></div>
            <div class="game-area" id="area"></div>
        </div>
        <div id="result" class="screen">
            <div class="result-aurora" id="result-aurora"></div>
            <div class="confetti-container" id="confetti"></div>
            <div class="stars-container" id="stars"></div>
            <div class="result-content" id="result-content"></div>
        </div>
    </div>

    <script>
        // ‚òÖ „Ç≤„Éº„É†Áï™Âè∑Ôºà„É°„Éã„É•„ÉºÈÄ£Êê∫Áî®Ôºâ
        const GAME_NUMBER = 1;
        const CLEAR_ROUND = 15;

        let highScore = parseInt(localStorage.getItem('kuukiHighScore')) || 0;
        document.getElementById('best-score').textContent = highScore.toLocaleString();

        function goBack() { window.location.href = 'index.html?menu=1'; }

        function createParticles() {
            const c = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random()*100+'%';
                p.style.animationDelay = Math.random()*10+'s';
                p.style.animationDuration = (8+Math.random()*8)+'s';
                const s = 2+Math.random()*5;
                p.style.width = s+'px'; p.style.height = s+'px';
                const colors = ['#6600ff','#00ccff','#0088ff','#cc00ff','#00ff88'];
                const col = colors[Math.floor(Math.random()*colors.length)];
                p.style.background = col;
                p.style.boxShadow = `0 0 ${s*3}px ${col}`;
                c.appendChild(p);
            }
        }
        createParticles();

        function createConfetti() {
            const c = document.getElementById('confetti'); c.innerHTML = '';
            const sh = ['‚ñ†','‚óè','‚ñ≤','‚òÖ','‚óÜ'];
            const co = ['#4ecdc4','#00ccff','#ffff00','#ffd700','#00ff88','#ff8800'];
            for (let i = 0; i < 80; i++) {
                const d = document.createElement('div'); d.className = 'confetti';
                d.textContent = sh[Math.floor(Math.random()*sh.length)];
                d.style.left = Math.random()*100+'%';
                d.style.color = co[Math.floor(Math.random()*co.length)];
                d.style.fontSize = (10+Math.random()*12)+'px';
                d.style.animationDuration = (2+Math.random()*3)+'s';
                d.style.animationDelay = Math.random()*2+'s';
                d.style.textShadow = `0 0 10px ${d.style.color}`;
                c.appendChild(d);
            }
        }
        function createStars() {
            const c = document.getElementById('stars'); c.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const s = document.createElement('div'); s.className = 'star'; s.textContent = '‚ú¶';
                    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
                    s.style.color = ['#ffd700','#fff','#4ecdc4'][Math.floor(Math.random()*3)];
                    c.appendChild(s); setTimeout(() => s.remove(), 1000);
                }, i * 200);
            }
        }

        let G = {
            round:0, lives:3, score:0, combo:0, maxCombo:0,
            fever:0, isFever:false, timer:null, timeLeft:0, baseTime:6000,
            passUsed:0, maxPass:3, answered:false, miniType:'',
            fallIntervals:[], lastMiniIdx:-1
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('gameplay').classList.remove('fever-mode');
        }
        function render(html) { document.getElementById('area').innerHTML = html; }
        function showSplash(text, cb, delay=500) {
            render(`<div class="round-splash">${text}</div>`);
            setTimeout(cb, delay);
        }
        function updateHUD() {
            document.getElementById('lives').textContent = '‚ù§Ô∏è'.repeat(G.lives) + 'üñ§'.repeat(3-G.lives);
            document.getElementById('score').textContent = G.score.toLocaleString();
            document.getElementById('combo').textContent = G.combo > 1 ? `${G.combo}„Ç≥„É≥„Éú!` : '';
            document.getElementById('fever-fill').style.width = `${Math.min(G.fever,100)}%`;
            document.getElementById('round-display').textContent = `ROUND ${G.round}`;
            document.getElementById('pass-icons').textContent = '‚ö™'.repeat(G.maxPass-G.passUsed) + '‚ö´'.repeat(G.passUsed);
            document.getElementById('mini-type').textContent = G.miniType;
            const remaining = Math.max(0, CLEAR_ROUND - G.round);
            const goalEl = document.getElementById('clear-goal');
            if (G.round >= CLEAR_ROUND) {
                goalEl.textContent = '‚úÖ „ÇØ„É™„Ç¢Êù°‰ª∂ÈÅîÊàêÔºÅ';
                goalEl.style.color = '#ffd700';
            } else {
                goalEl.textContent = `üéØ „ÇØ„É™„Ç¢„Åæ„Åß: „ÅÇ„Å®${remaining + 1}`;
            }
        }
        function getTimeForRound() { return Math.max(2500, G.baseTime - (G.round-1)*80); }
        function startTimer(time, onTimeout) {
            clearInterval(G.timer);
            G.timeLeft = time;
            const bar = document.getElementById('timer');
            bar.style.width = '100%'; bar.className = 'timer-bar';
            G.timer = setInterval(() => {
                G.timeLeft -= 30;
                const pct = G.timeLeft / time * 100;
                bar.style.width = pct + '%';
                if (pct < 25) bar.className = 'timer-bar danger';
                else if (pct < 50) bar.className = 'timer-bar warn';
                if (G.timeLeft <= 0) { clearInterval(G.timer); if (onTimeout) onTimeout(); }
            }, 30);
        }
        function stopTimer() { clearInterval(G.timer); }
        function clearFallIntervals() { G.fallIntervals.forEach(id => {clearInterval(id); clearTimeout(id);}); G.fallIntervals = []; }

        function startGame() {
            G.round=0; G.lives=3; G.score=0; G.combo=0; G.maxCombo=0;
            G.fever=0; G.isFever=false; G.passUsed=0; G.answered=false; G.miniType=''; G.lastMiniIdx=-1;
            showScreen('gameplay');
            showSplash('ü´ß READY', () => showSplash('GO!', nextRound, 300), 400);
        }
        function nextRound() {
            if (G.lives <= 0) return endGame();
            G.round++; G.answered = false;
            clearFallIntervals(); updateHUD();
            if (G.fever >= 100 && !G.isFever) {
                G.isFever = true;
                document.getElementById('gameplay').classList.add('fever-mode');
                popup('üî• FEVER! üî•', 'fever');
            }
            if (G.round === CLEAR_ROUND) {
                showSplash('üéØ CLEARÊù°‰ª∂ÈÅîÊàê!', playRound, 600);
            } else if (G.round % 10 === 1 && G.round > 1) {
                showSplash(`üî• ROUND ${G.round}!`, playRound, 500);
            } else {
                playRound();
            }
        }
        function handleCorrect() {
            if (G.answered) return; G.answered = true;
            stopTimer(); clearFallIntervals();
            G.combo++; if (G.combo > G.maxCombo) G.maxCombo = G.combo;
            const m = G.isFever ? 2 : 1;
            const pts = (100 + G.combo * 25) * m;
            G.score += pts; G.fever = Math.min(G.fever + 15, 100);
            flash('hit');
            if (G.combo >= 10) popup('üåü AMAZING!', 'perfect');
            else if (G.combo >= 5) popup('üî• PERFECT!', 'perfect');
            else if (G.combo >= 3) popup('GREAT!', 'great');
            else popup(`+${pts}`, 'nice');
            updateHUD(); setTimeout(nextRound, 400);
        }
        function handleWrong() {
            if (G.answered) return; G.answered = true;
            stopTimer(); clearFallIntervals();
            G.lives--; G.combo = 0;
            G.fever = Math.max(G.fever - 30, 0); G.isFever = false;
            document.getElementById('gameplay').classList.remove('fever-mode');
            flash('miss'); popup('MISS...', 'miss'); updateHUD();
            setTimeout(() => { if (G.lives <= 0) endGame(); else nextRound(); }, 500);
        }
        function handlePass() {
            if (G.answered || G.passUsed >= G.maxPass) return;
            G.answered = true; stopTimer(); clearFallIntervals();
            G.passUsed++; G.combo = 0; G.fever = Math.max(G.fever - 10, 0);
            flash('pass'); popup('PASS', 'pass'); updateHUD();
            setTimeout(nextRound, 300);
        }
        function popup(text, type) {
            const p = document.createElement('div');
            p.className = `popup ${type}`; p.textContent = text;
            document.body.appendChild(p); setTimeout(() => p.remove(), 600);
        }
        function flash(type) {
            const f = document.getElementById('flash');
            f.className = 'flash ' + type;
            setTimeout(() => f.className = 'flash', 200);
        }
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
            return a;
        }
        function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
        function passButtonHTML() {
            const r = G.maxPass - G.passUsed;
            return `<div class="pass-container"><button class="game-btn btn-pass" onclick="handlePass()" ${r<=0?'disabled':''}>‚è≠ „Éë„Çπ</button><div class="pass-remaining">ÊÆã„Çä ${r} Âõû</div></div>`;
        }

        const TARGET = '„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ';
        const TARGET_CHARS = ['„Åè','„ÅÜ','„Åç','„Åå','„Å™','„ÅÑ'];
        const DECOY_CHARS = ['„Åë','„Åä','„Åã','„Åé','„Å¨','„Åà','„Åì','„ÅÇ','„Åï','„Åó','„Åô','„Åõ','„Åù','„Åü','„Å°','„Å§','„Å¶','„Å®','„Å´','„ÅÆ','„ÅØ','„Å≤','„Åµ','„Å∏','„Åª','„Åæ','„Åø','„ÇÄ','„ÇÅ','„ÇÇ','„ÇÑ','„ÇÜ','„Çà','„Çâ','„Çä','„Çã','„Çå','„Çç','„Çè','„Çí','„Çì','„Åî','„Åê','„Åí','„Åñ','„Åö','„Åú','„Åû','„Å†','„Åß','„Å©'];

        // ====== „Éü„Éã„Ç≤„Éº„É†1: Á©¥Âüã„ÇÅ ======
        function miniGame_fillBlank() {
            G.miniType = 'üß© Á©¥Âüã„ÇÅ„Éë„Ç∫„É´'; updateHUD();
            const blankCount = Math.min(1+Math.floor(G.round/8), 4);
            const indices = shuffle([0,1,2,3,4,5]).slice(0, blankCount);
            let blanks = new Set(indices), filled = {}, currentBlank = 0;
            const sortedIdx = [...indices].sort((a,b)=>a-b);
            const decoys = shuffle(DECOY_CHARS).slice(0, Math.max(3, 6-blankCount));
            const answers = sortedIdx.map(i=>TARGET_CHARS[i]);
            const allChoices = shuffle([...answers, ...decoys]);
            function renderFill() {
                let w = '';
                for (let i=0; i<TARGET_CHARS.length; i++) {
                    if (blanks.has(i)) { const c = filled[i]?'blank filled':'blank'; w += `<span class="${c}">${filled[i]||''}</span>`; }
                    else w += TARGET_CHARS[i];
                }
                let ch = allChoices.map((c,idx) => {
                    const used = Object.values(filled).filter(v=>v===c).length >= allChoices.filter(v=>v===c).length;
                    return `<button class="fill-choice ${used?'used':''}" onclick="fillSelect('${c}')">${c}</button>`;
                }).join('');
                render(`<div class="mini-label">üß© Á©¥Âüã„ÇÅ„Éë„Ç∫„É´</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÇíÂÆåÊàê„Åï„Åõ„Çà„ÅÜÔºÅ</div><div class="fill-word">${w}</div><div class="fill-choices">${ch}</div>${passButtonHTML()}`);
            }
            window.fillSelect = function(ch) {
                if (G.answered) return;
                const ti = sortedIdx[currentBlank];
                if (ch === TARGET_CHARS[ti]) { filled[ti]=ch; currentBlank++; if(currentBlank>=sortedIdx.length) handleCorrect(); else renderFill(); }
                else handleWrong();
            };
            renderFill();
            startTimer(getTimeForRound()+blankCount*1000, ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†2: ÊñáÂ≠ó„Åï„Åå„Åó ======
        function miniGame_findChar() {
            G.miniType = 'üîç ÊñáÂ≠ó„Åï„Åå„Åó'; updateHUD();
            const tc = pick(TARGET_CHARS), tn = 1+Math.floor(Math.random()*2);
            let cells = [], found = 0;
            for (let i=0;i<tn;i++) cells.push({char:tc,isTarget:true});
            const decoys = DECOY_CHARS.filter(c=>c!==tc);
            for (let i=0;i<16-tn;i++) cells.push({char:pick(decoys),isTarget:false});
            cells = shuffle(cells);
            window.cellTap = function(idx) {
                if(G.answered) return;
                const el = document.getElementById('cell-'+idx);
                if(cells[idx].isTarget) { el.classList.add('correct'); el.style.pointerEvents='none'; found++; if(found>=tn) handleCorrect(); }
                else { el.classList.add('wrong'); handleWrong(); }
            };
            render(`<div class="mini-label">üîç ÊñáÂ≠ó„Åï„Åå„Åó</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆ„Äå<span class="highlight">${tc}</span>„Äç„Çí${tn}„Å§Ë¶ã„Å§„Åë„Çà„ÅÜÔºÅ</div><div class="char-grid">${cells.map((c,i)=>`<div class="char-cell" id="cell-${i}" onclick="cellTap(${i})">${c.char}</div>`).join('')}</div>${passButtonHTML()}`);
            startTimer(getTimeForRound(), ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†3: È†ÜÁï™„Çø„ÉÉ„Éó ======
        function miniGame_orderTap() {
            G.miniType = 'üìù È†ÜÁï™„Çø„ÉÉ„Éó'; updateHUD();
            let ci = 0;
            const decoys = shuffle(DECOY_CHARS).slice(0,10);
            let cells = shuffle([...TARGET_CHARS, ...decoys]);
            let doneSet = new Set();
            function renderO() {
                let o = TARGET_CHARS.map((ch,i) => i<ci?`<span class="done">${ch}</span>`:i===ci?`<span class="current">${ch}</span>`:`<span class="remaining">${ch}</span>`).join(' ');
                render(`<div class="mini-label">üìù È†ÜÁï™„Çø„ÉÉ„Éó</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÇíÈ†ÜÁï™„Å´„Çø„ÉÉ„ÉóÔºÅ</div><div class="order-display">${o}</div><div class="char-grid">${cells.map((c,i)=>`<div class="char-cell ${doneSet.has(i)?'correct':''}" id="ocell-${i}" onclick="orderTap(${i})">${c}</div>`).join('')}</div>${passButtonHTML()}`);
            }
            window.orderTap = function(idx) {
                if(G.answered || doneSet.has(idx)) return;
                if(cells[idx]===TARGET_CHARS[ci]) { doneSet.add(idx); ci++; if(ci>=TARGET_CHARS.length) handleCorrect(); else renderO(); }
                else { document.getElementById('ocell-'+idx)?.classList.add('wrong'); handleWrong(); }
            };
            renderO();
            startTimer(getTimeForRound()+2000, ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†4: ‚óã√ó„ÇØ„Ç§„Ç∫ ======
        function miniGame_trueFalse() {
            G.miniType = '‚≠ï ‚óã√ó„ÇØ„Ç§„Ç∫'; updateHUD();
            const qs = [
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅØ6ÊñáÂ≠ó„Åß„ÅÇ„Çã',a:true},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅØ5ÊñáÂ≠ó„Åß„ÅÇ„Çã',a:false},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´„Äå„Åç„Äç„ÅåÂê´„Åæ„Çå„Çã',a:true},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´„Äå„Åë„Äç„ÅåÂê´„Åæ„Çå„Çã',a:false},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ3ÊñáÂ≠óÁõÆ„ÅØ„Äå„Åç„Äç',a:true},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅØ„Äå„Åè„Äç„ÅßÂßã„Åæ„Çã',a:true},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅØ„Äå„ÅÜ„Äç„ÅßÂßã„Åæ„Çã',a:false},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅØ„Äå„ÅÑ„Äç„ÅßÁµÇ„Çè„Çã',a:true},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´ÊøÅÈü≥„ÅåÂê´„Åæ„Çå„Çã',a:true},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ4ÊñáÂ≠óÁõÆ„ÅØ„Äå„Åå„Äç',a:true},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ2ÊñáÂ≠óÁõÆ„ÅØ„Äå„Åè„Äç',a:false},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´„Äå„Å¨„Äç„ÅåÂê´„Åæ„Çå„Çã',a:false},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÇíÈÄÜ„Å´„Åô„Çã„Å®„Äå„ÅÑ„Å™„Åå„Åç„ÅÜ„Åè„Äç',a:true},{q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´Âêå„ÅòÊñáÂ≠ó„ÅØ„Å™„ÅÑ',a:true},
            ];
            const q = pick(qs);
            window.tfAnswer = function(a) { if(G.answered) return; a===q.a ? handleCorrect() : handleWrong(); };
            render(`<div class="mini-label">‚≠ï ‚óã√ó„ÇØ„Ç§„Ç∫</div><div class="question-text" style="font-size:1.2em;margin:20px 0;">${q.q}</div><div class="button-container"><button class="game-btn btn-correct" onclick="tfAnswer(true)" style="font-size:1.8em;padding:20px 50px;">‚≠ï</button><button class="game-btn btn-wrong" onclick="tfAnswer(false)" style="font-size:1.8em;padding:20px 50px;">‚úñÔ∏è</button></div>${passButtonHTML()}`);
            startTimer(getTimeForRound(), ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†5: „Éê„Éñ„É´„Çø„ÉÉ„ÉÅ ======
        function miniGame_bubbleTap() {
            G.miniType = 'ü´ß „Éê„Éñ„É´„Çø„ÉÉ„ÉÅ'; updateHUD();
            const tc = pick(TARGET_CHARS);
            const bc = 8+Math.min(Math.floor(G.round/5),6);
            let targetBubbles=0, tapped=0, bubbles=[];
            const needed = 2+Math.floor(Math.random()*2);
            for(let i=0;i<bc;i++) {
                const isT = i<needed; if(isT) targetBubbles++;
                bubbles.push({char:isT?tc:pick(DECOY_CHARS.filter(c=>c!==tc)),isTarget:isT,x:10+Math.random()*60,y:10+Math.random()*70,size:50+Math.random()*25});
            }
            bubbles = shuffle(bubbles);
            window.bubbleTap = function(i) {
                if(G.answered) return; const el=document.getElementById('bubble-'+i); if(!el) return;
                if(bubbles[i].isTarget) { el.classList.add('pop'); tapped++; if(tapped>=targetBubbles) handleCorrect(); }
                else { el.classList.add('pop'); handleWrong(); }
            };
            const colors=['#6600ff','#0066ff','#00cccc','#cc00ff','#0088ff'];
            render(`<div class="mini-label">ü´ß „Éê„Éñ„É´„Çø„ÉÉ„ÉÅ</div><div class="question-text">„Åè„ÅÜ„Åç„ÅÆÊ≥°„Åã„Çâ„Äå<span class="highlight">${tc}</span>„Äç„Å†„Åë„Çí„Çø„ÉÉ„ÉóÔºÅ</div><div class="bubble-area">${bubbles.map((b,i)=>{const c=b.isTarget?'#00cc66':pick(colors);return`<div class="bubble" id="bubble-${i}" onclick="bubbleTap(${i})" style="left:${b.x}%;top:${b.y}%;width:${b.size}px;height:${b.size}px;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,0.3),${c});border:2px solid rgba(255,255,255,0.2);animation-delay:${Math.random()*2}s;font-size:${b.size*0.4}px;">${b.char}</div>`;}).join('')}</div>${passButtonHTML()}`);
            startTimer(getTimeForRound()+1000, ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†6: 4Êäû„ÇØ„Ç§„Ç∫ ======
        function miniGame_quiz4() {
            G.miniType = '‚ùì 4Êäû„ÇØ„Ç§„Ç∫'; updateHUD();
            const pool = [
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆÊñáÂ≠óÊï∞„ÅØÔºü',ch:['5ÊñáÂ≠ó','6ÊñáÂ≠ó','7ÊñáÂ≠ó','4ÊñáÂ≠ó'],c:1},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆÊúÄÂàù„ÅÆÊñáÂ≠ó„ÅØÔºü',ch:['„Åç','„Åè','„ÅÜ','„Åã'],c:1},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆÊúÄÂæå„ÅÆÊñáÂ≠ó„ÅØÔºü',ch:['„Å™','„ÅÑ','„Åå','„Åç'],c:1},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„Å´Âê´„Åæ„Çå„Å™„ÅÑÊñáÂ≠ó„ÅØÔºü',ch:['„Åè','„ÅÜ','„Åë','„Åå'],c:2},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ3Áï™ÁõÆ„ÅÆÊñáÂ≠ó„ÅØÔºü',ch:['„ÅÜ','„Åå','„Åç','„Åè'],c:2},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÇíÊº¢Â≠ó„Å´„Åô„Çã„Å®Ôºü',ch:['Á©∫Ê∞ó„Åå„Å™„ÅÑ','È£ü„ÅÜÊ∞ó„Åå„Å™„ÅÑ','‰πùÊú®„Åå„Å™„ÅÑ','Á©∫Êú®„Åå„Å™„ÅÑ'],c:0},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅßÊøÅÈü≥„ÅØ„Å©„ÇåÔºü',ch:['„Åè','„ÅÜ','„Åå','„Å™'],c:2},
                {q:'„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ5Áï™ÁõÆ„ÅÆÊñáÂ≠ó„ÅØÔºü',ch:['„ÅÑ','„Å™','„Åå','„Åç'],c:1},
            ];
            const q = pick(pool);
            window.quiz4Answer = function(i) {
                if(G.answered) return;
                document.querySelectorAll('.quiz-choice')[q.c].classList.add('correct-answer');
                if(i===q.c) handleCorrect(); else { document.querySelectorAll('.quiz-choice')[i].classList.add('wrong-answer'); handleWrong(); }
            };
            render(`<div class="mini-label">‚ùì 4Êäû„ÇØ„Ç§„Ç∫</div><div class="question-text" style="font-size:1.15em;margin:15px 0;">${q.q}</div><div class="quiz-choices">${q.ch.map((c,i)=>`<button class="quiz-choice" onclick="quiz4Answer(${i})">${c}</button>`).join('')}</div>${passButtonHTML()}`);
            startTimer(getTimeForRound(), ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†7: ËêΩ‰∏ã„Ç≠„É£„ÉÉ„ÉÅ ======
        function miniGame_fallCatch() {
            G.miniType = '‚¨áÔ∏è ËêΩ‰∏ã„Ç≠„É£„ÉÉ„ÉÅ'; updateHUD();
            const tc = pick(TARGET_CHARS); let caught=false, sc=0;
            window.catchChar = function(id, isT) {
                if(G.answered) return; const el=document.getElementById('fall-'+id); if(!el) return;
                el.classList.add('caught'); el.style.pointerEvents='none';
                if(isT) { caught=true; handleCorrect(); } else handleWrong();
            };
            render(`<div class="mini-label">‚¨áÔ∏è ËêΩ‰∏ã„Ç≠„É£„ÉÉ„ÉÅ</div><div class="question-text">ËêΩ„Å°„Å¶„Åè„Çã„Äå<span class="highlight">${tc}</span>„Äç„Çí„Ç≠„É£„ÉÉ„ÉÅÔºÅ<br><small style="color:#666;">„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆÊñáÂ≠ó„ÇíÊé¥„ÇÅÔºÅ</small></div><div class="fall-area" id="fall-area"></div>${passButtonHTML()}`);
            const area = document.getElementById('fall-area'); let fid=0;
            const si = setInterval(() => {
                if(G.answered||sc>=12) { clearInterval(si); return; }
                sc++;
                const isT = sc%4===0||(sc===12&&!caught);
                const ch = isT?tc:pick(DECOY_CHARS.filter(c=>c!==tc));
                const id=fid++, x=5+Math.random()*80, dur=2+Math.random()*1.5;
                const el=document.createElement('div'); el.className='fall-char'; el.id='fall-'+id;
                el.textContent=ch; el.style.left=x+'%'; el.style.color=isT?'#00ff88':'#ff4466';
                el.style.animationDuration=dur+'s'; el.onclick=()=>catchChar(id,isT);
                area.appendChild(el); setTimeout(()=>{if(el.parentNode)el.remove();},dur*1000);
            }, 500);
            G.fallIntervals.push(si);
            startTimer(getTimeForRound()+3000, ()=>{clearInterval(si); if(!G.answered)handleWrong();});
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†8: ÂèçÂ∞Ñ„Çø„ÉÉ„Éó ======
        function miniGame_reflexTap() {
            G.miniType = '‚ö° ÂèçÂ∞Ñ„Çø„ÉÉ„Éó'; updateHUD();
            const allC = [...TARGET_CHARS, ...DECOY_CHARS.slice(0,6)];
            const dc = pick(allC), isT = TARGET_CHARS.includes(dc);
            let cells = Array(9).fill('');
            const li = Math.floor(Math.random()*9); cells[li]=dc;
            let tapped=false, tid;
            window.reflexTap = function(i) {
                if(G.answered||tapped) return; tapped=true; clearTimeout(tid);
                if(i===li&&isT) handleCorrect(); else handleWrong();
            };
            render(`<div class="mini-label">‚ö° ÂèçÂ∞Ñ„Çø„ÉÉ„Éó</div><div class="question-text">ÂÖâ„Å£„Åü„Éû„Çπ„Åå„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆÊñáÂ≠ó„Å™„Çâ<br>Âç≥„Çø„ÉÉ„ÉóÔºÅÈÅï„ÅÜ„Å™„Çâ„Çπ„É´„ÉºÔºÅ</div><div class="reflex-grid">${cells.map((c,i)=>`<div class="reflex-cell ${i===li?'lit':''}" onclick="reflexTap(${i})">${c}</div>`).join('')}</div>${passButtonHTML()}`);
            if(!isT) { tid=setTimeout(()=>{if(!G.answered&&!tapped)handleCorrect();}, Math.max(1500,getTimeForRound()*0.6)); G.fallIntervals.push(tid); }
            startTimer(getTimeForRound(), ()=>{if(!tapped&&isT)handleWrong();else if(!tapped&&!isT)handleCorrect();});
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†9: „Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö ======
        function miniGame_swipe() {
            G.miniType = 'üëÜ „Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö'; updateHUD();
            const allC = [...TARGET_CHARS, ...DECOY_CHARS.slice(0,8)];
            const dc = pick(allC), isIn = TARGET_CHARS.includes(dc);
            let startX=0, currentX=0, swiping=false;
            window.swipeStart=function(e){if(G.answered)return;swiping=true;startX=e.touches?e.touches[0].clientX:e.clientX;};
            window.swipeMove=function(e){if(!swiping||G.answered)return;currentX=(e.touches?e.touches[0].clientX:e.clientX)-startX;const c=document.getElementById('swipe-card');if(c){c.style.transform=`translateX(${currentX}px) rotate(${currentX*0.1}deg)`;c.style.opacity=Math.max(0.3,1-Math.abs(currentX)/300);}};
            window.swipeEnd=function(){if(!swiping||G.answered)return;swiping=false;if(Math.abs(currentX)>80){const r=currentX>0;(r&&isIn)||(!r&&!isIn)?handleCorrect():handleWrong();}else{const c=document.getElementById('swipe-card');if(c){c.style.transform='';c.style.opacity='1';}}currentX=0;};
            window.swipeBtnLeft=function(){if(G.answered)return;!isIn?handleCorrect():handleWrong();};
            window.swipeBtnRight=function(){if(G.answered)return;isIn?handleCorrect():handleWrong();};
            render(`<div class="mini-label">üëÜ „Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„Å´Âê´„Åæ„Çå„ÇãÔºü</div><div class="swipe-card" id="swipe-card" ontouchstart="swipeStart(event)" ontouchmove="swipeMove(event)" ontouchend="swipeEnd()" onmousedown="swipeStart(event)" onmousemove="swipeMove(event)" onmouseup="swipeEnd()">${dc}<div class="card-label">„Åì„ÅÆÊñáÂ≠ó„ÅØÔºü</div></div><div class="swipe-hint"><span class="left-hint">‚Üê Âê´„Åæ„Çå„Å™„ÅÑ</span><span class="right-hint">Âê´„Åæ„Çå„Çã ‚Üí</span></div><div class="button-container" style="margin-top:15px;"><button class="game-btn btn-wrong" onclick="swipeBtnLeft()" style="padding:12px 25px;font-size:1em;">‚úñ ÁÑ°„ÅÑ</button><button class="game-btn btn-correct" onclick="swipeBtnRight()" style="padding:12px 25px;font-size:1em;">‚≠ï „ÅÇ„Çã</button></div>${passButtonHTML()}`);
            startTimer(getTimeForRound(), ()=>handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†10: Ë®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏ ======
        function miniGame_memory() {
            G.miniType = 'üß† Ë®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏'; updateHUD();
            const ai = Math.floor(Math.random()*TARGET_CHARS.length);
            const cc = TARGET_CHARS[ai];
            const decoys = shuffle(DECOY_CHARS.filter(c=>c!==cc)).slice(0,3);
            const choices = shuffle([cc,...decoys]);
            render(`<div class="mini-label">üß† Ë®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏</div><div class="question-text">„Çà„ÅèË¶ö„Åà„Å¶ÔºÅ</div><div class="memory-display show">„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</div>`);
            const st = Math.max(800, 2000-G.round*50);
            const tid = setTimeout(() => {
                if(G.answered) return;
                window.memAnswer=function(ch){if(G.answered)return;ch===cc?handleCorrect():handleWrong();};
                render(`<div class="mini-label">üß† Ë®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏</div><div class="question-text">„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆ<br><span class="highlight">${ai+1}ÊñáÂ≠óÁõÆ</span>„ÅØ‰Ωï„Å†„Å£„ÅüÔºü</div><div class="memory-display hide"></div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="memAnswer('${c}')">${c}</button>`).join('')}</div>${passButtonHTML()}`);
                startTimer(getTimeForRound(), ()=>handleWrong());
            }, st);
            G.fallIntervals.push(tid);
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†11: „É¢„Ç∞„É©Âè©„Åç ======
        function miniGame_whackMole() {
            G.miniType = 'üî® „É¢„Ç∞„É©Âè©„Åç'; updateHUD();
            const tc = pick(TARGET_CHARS);
            let hit = false, moleTimer;
            function spawnMole() {
                if (G.answered) return;
                const holes = document.querySelectorAll('.mole-hole');
                holes.forEach(h => h.classList.remove('active'));
                const idx = Math.floor(Math.random() * 9);
                const isT = Math.random() < 0.4;
                const ch = isT ? tc : pick(DECOY_CHARS.filter(c => c !== tc));
                const hole = holes[idx];
                if (!hole) return;
                hole.querySelector('.mole-char').textContent = ch;
                hole.dataset.isTarget = isT;
                hole.classList.add('active');
                const hideTime = Math.max(600, 1200 - G.round * 30);
                const hideId = setTimeout(() => {
                    hole.classList.remove('active');
                    if (!G.answered) moleTimer = setTimeout(spawnMole, 300);
                }, hideTime);
                G.fallIntervals.push(hideId);
            }
            window.moleTap = function(idx) {
                if (G.answered) return;
                const hole = document.querySelectorAll('.mole-hole')[idx];
                if (!hole || !hole.classList.contains('active')) return;
                hole.classList.remove('active');
                if (hole.dataset.isTarget === 'true') { hit = true; handleCorrect(); }
                else handleWrong();
            };
            render(`<div class="mini-label">üî® „É¢„Ç∞„É©Âè©„Åç</div><div class="question-text">Á©¥„Åã„ÇâÂá∫„Çã„Äå<span class="highlight">${tc}</span>„Äç„ÇíÂè©„ÅëÔºÅ<br><small style="color:#666;">„Äå„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ„Äç„ÅÆÊñáÂ≠ó„Å†ÔºÅ</small></div><div class="mole-grid">${Array(9).fill(0).map((_,i)=>`<div class="mole-hole" onclick="moleTap(${i})"><span class="mole-char"></span></div>`).join('')}</div>${passButtonHTML()}`);
            const startId = setTimeout(spawnMole, 500);
            G.fallIntervals.push(startId);
            startTimer(getTimeForRound() + 3000, () => { if (!G.answered) handleWrong(); });
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†12: „Çπ„É≠„ÉÉ„Éà ======
        function miniGame_slot() {
            G.miniType = 'üé∞ „Çπ„É≠„ÉÉ„Éà'; updateHUD();
            const targetIdx = Math.floor(Math.random() * TARGET_CHARS.length);
            const targetChar = TARGET_CHARS[targetIdx];
            const reelChars = shuffle([...TARGET_CHARS, ...DECOY_CHARS.slice(0, 6)]);
            let spinning = true, currentCharIdx = 0, spinInterval;
            function updateReel() {
                const reel = document.getElementById('slot-main');
                if (!reel) return;
                currentCharIdx = (currentCharIdx + 1) % reelChars.length;
                reel.textContent = reelChars[currentCharIdx];
            }
            window.stopSlot = function() {
                if (G.answered || !spinning) return;
                spinning = false; clearInterval(spinInterval);
                const reel = document.getElementById('slot-main');
                if (!reel) return; reel.classList.remove('spinning');
                if (reelChars[currentCharIdx] === targetChar) { reel.classList.add('stopped'); handleCorrect(); }
                else { reel.classList.add('wrong-stop'); handleWrong(); }
            };
            render(`<div class="mini-label">üé∞ „Çπ„É≠„ÉÉ„Éà</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆ<br><span class="highlight">${targetIdx+1}ÊñáÂ≠óÁõÆ„Äå${targetChar}„Äç</span>„ÅßÊ≠¢„ÇÅ„ÇçÔºÅ</div><div class="slot-container"><div class="slot-reel" style="opacity:0.4;">${targetIdx>0?TARGET_CHARS[targetIdx-1]:'„ÄÄ'}</div><div class="slot-reel spinning" id="slot-main">${reelChars[0]}</div><div class="slot-reel" style="opacity:0.4;">${targetIdx<5?TARGET_CHARS[targetIdx+1]:'„ÄÄ'}</div></div><div class="button-container"><button class="game-btn btn-correct" onclick="stopSlot()" style="font-size:1.5em;padding:20px 60px;">‚èπ STOP</button></div>${passButtonHTML()}`);
            spinInterval = setInterval(updateReel, 80);
            G.fallIntervals.push(spinInterval);
            startTimer(getTimeForRound() + 2000, () => { clearInterval(spinInterval); if (!G.answered) handleWrong(); });
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†13: ÊñáÂ≠ó„Ç´„Ç¶„É≥„Éà ======
        function miniGame_count() {
            G.miniType = 'üî¢ ÊñáÂ≠ó„Ç´„Ç¶„É≥„Éà'; updateHUD();
            const tc = pick(TARGET_CHARS);
            const total = 16 + Math.floor(Math.random() * 9);
            const correctCount = 2 + Math.floor(Math.random() * 4);
            let chars = [];
            for (let i = 0; i < correctCount; i++) chars.push(tc);
            const decoys = DECOY_CHARS.filter(c => c !== tc);
            for (let i = 0; i < total - correctCount; i++) chars.push(pick(decoys));
            chars = shuffle(chars);
            const options = [correctCount];
            while (options.length < 4) {
                const v = correctCount + (Math.floor(Math.random() * 5) - 2);
                if (v > 0 && !options.includes(v)) options.push(v);
            }
            const sortedOpts = shuffle(options);
            window.countAnswer = function(v) { if (G.answered) return; v === correctCount ? handleCorrect() : handleWrong(); };
            render(`<div class="mini-label">üî¢ ÊñáÂ≠ó„Ç´„Ç¶„É≥„Éà</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆ„Äå<span class="highlight">${tc}</span>„Äç„ÅØ‰ΩïÂÄãÔºü</div><div class="count-area">${chars.map(c => `<div class="count-char">${c}</div>`).join('')}</div><div class="count-choices">${sortedOpts.map(v => `<button class="count-choice" onclick="countAnswer(${v})">${v}</button>`).join('')}</div>${passButtonHTML()}`);
            startTimer(getTimeForRound() + 2000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†14: „Çø„Ç§„Éî„É≥„Ç∞ ======
        function miniGame_typing() {
            G.miniType = '‚å®Ô∏è „Çø„Ç§„Éî„É≥„Ç∞'; updateHUD();
            let ci = 0;
            const decoys = shuffle(DECOY_CHARS).slice(0, 6);
            const keys = shuffle([...TARGET_CHARS, ...decoys]);
            function renderTyping() {
                let display = TARGET_CHARS.map((c, i) => {
                    if (i < ci) return `<span class="typed">${c}</span>`;
                    if (i === ci) return `<span class="cursor-char">${c}</span>`;
                    return `<span class="untyped">${c}</span>`;
                }).join('');
                render(`<div class="mini-label">‚å®Ô∏è „Çø„Ç§„Éî„É≥„Ç∞</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÇíÊâì„Å¶ÔºÅ</div><div class="typing-display">${display}</div><div class="typing-keys">${keys.map(k => `<button class="typing-key" onclick="typeKey('${k}')">${k}</button>`).join('')}</div>${passButtonHTML()}`);
            }
            window.typeKey = function(k) {
                if (G.answered) return;
                if (k === TARGET_CHARS[ci]) { ci++; if (ci >= TARGET_CHARS.length) handleCorrect(); else renderTyping(); }
                else handleWrong();
            };
            renderTyping();
            startTimer(getTimeForRound() + 2000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†15: Ë°®Ë®ò„ÉÅ„Çß„ÉÉ„ÇØ ======
        function miniGame_spellCheck() {
            G.miniType = 'ü™û Ë°®Ë®ò„ÉÅ„Çß„ÉÉ„ÇØ'; updateHUD();
            const variants = [
                {text:'„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ',correct:true},{text:'„Åè„ÅÜ„Åé„Åå„Å™„ÅÑ',correct:false},
                {text:'„Åè„ÅÜ„Åç„Åå„Å™„Åó',correct:false},{text:'„Åè„ÅÜ„Åç„Åã„Å™„ÅÑ',correct:false},
                {text:'„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ',correct:true},{text:'„Åì„ÅÜ„Åç„Åå„Å™„ÅÑ',correct:false},
                {text:'„Åè„ÅÜ„Åç„Åå„Åü„ÅÑ',correct:false},{text:'„Åè„ÅÜ„Åç„Åå„Å™„ÅÉ',correct:false},
                {text:'„Åè„ÅÜ„Åé„Åã„Å™„ÅÑ',correct:false},{text:'„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ',correct:true},
                {text:'„Åè„ÅÜ„Åç„Åã„Å™„Çä',correct:false},{text:'„Å§„ÅÜ„Åç„Åå„Å™„ÅÑ',correct:false},
            ];
            const v = pick(variants);
            window.spellAnswer = function(ans) { if (G.answered) return; ans === v.correct ? handleCorrect() : handleWrong(); };
            render(`<div class="mini-label">ü™û Ë°®Ë®ò„ÉÅ„Çß„ÉÉ„ÇØ</div><div class="question-text">„Åì„ÅÆË°®Ë®ò„ÅØÊ≠£„Åó„ÅÑÔºü</div><div class="mirror-text">${v.text}</div><div class="button-container"><button class="game-btn btn-correct" onclick="spellAnswer(true)" style="font-size:1.5em;padding:18px 45px;">‚≠ï Ê≠£„Åó„ÅÑ</button><button class="game-btn btn-wrong" onclick="spellAnswer(false)" style="font-size:1.5em;padding:18px 45px;">‚úñ ÈÅï„ÅÜ</button></div>${passButtonHTML()}`);
            startTimer(getTimeForRound(), () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†16: „ÉÅ„Çß„Éº„É≥Êé¢„Åó ======
        function miniGame_chainFind() {
            G.miniType = 'üîó „ÉÅ„Çß„Éº„É≥Êé¢„Åó'; updateHUD();
            const before = Math.floor(Math.random() * 4);
            const after = Math.floor(Math.random() * 4);
            let chain = [];
            for (let i = 0; i < before; i++) chain.push(pick(DECOY_CHARS));
            const startIdx = chain.length;
            chain.push(...TARGET_CHARS);
            for (let i = 0; i < after; i++) chain.push(pick(DECOY_CHARS));
            let tappedCount = 0, tappedSet = new Set();
            window.chainTap = function(idx) {
                if (G.answered) return;
                if (idx >= startIdx && idx < startIdx + 6 && !tappedSet.has(idx)) {
                    tappedSet.add(idx); document.getElementById('chain-' + idx)?.classList.add('found');
                    tappedCount++; if (tappedCount >= 6) handleCorrect();
                } else if (!tappedSet.has(idx)) handleWrong();
            };
            render(`<div class="mini-label">üîó „ÉÅ„Çß„Éº„É≥Êé¢„Åó</div><div class="question-text">ÊñáÂ≠óÂàó„ÅÆ‰∏≠„Åã„Çâ<br>„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÇíÂÖ®ÈÉ®„Çø„ÉÉ„ÉóÔºÅ</div><div class="chain-display">${chain.map((c, i) => `<div class="chain-char" id="chain-${i}" onclick="chainTap(${i})">${c}</div>`).join('')}</div>${passButtonHTML()}`);
            startTimer(getTimeForRound() + 2000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†17: ÈÄ£Êâì„ÉÅ„É£„É¨„É≥„Ç∏ ======
        function miniGame_rapidTap() {
            G.miniType = 'üí• ÈÄ£Êâì„ÉÅ„É£„É¨„É≥„Ç∏'; updateHUD();
            const tc = pick(TARGET_CHARS);
            const goal = 8 + Math.min(Math.floor(G.round / 3), 12);
            let count = 0;
            window.rapidTap = function() {
                if (G.answered) return; count++;
                const counter = document.getElementById('rapid-count');
                if (counter) counter.textContent = count;
                const prog = document.getElementById('rapid-prog');
                if (prog) prog.style.width = Math.min(100, count / goal * 100) + '%';
                if (count >= goal) handleCorrect();
            };
            render(`<div class="mini-label">üí• ÈÄ£Êâì„ÉÅ„É£„É¨„É≥„Ç∏</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆ„Äå<span class="highlight">${tc}</span>„Äç„Çí<br>${goal}ÂõûÈÄ£Êâì„Åó„ÇçÔºÅ</div><div class="tap-counter"><span id="rapid-count">0</span> / ${goal}</div><div style="width:80%;max-width:280px;height:16px;background:#222;border-radius:8px;overflow:hidden;margin:10px 0;border:2px solid #444;"><div id="rapid-prog" style="height:100%;width:0%;background:linear-gradient(90deg,#6600ff,#00ccff);border-radius:6px;transition:width 0.1s;"></div></div><button class="tap-target-btn" onclick="rapidTap()">${tc}</button>${passButtonHTML()}`);
            startTimer(getTimeForRound() + 1000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†18: ÈÄÜÈ†Ü„Çø„ÉÉ„Éó ======
        function miniGame_reverse() {
            G.miniType = 'üîÑ ÈÄÜÈ†Ü„Çø„ÉÉ„Éó'; updateHUD();
            const reversed = [...TARGET_CHARS].reverse();
            let ci = 0;
            const decoys = shuffle(DECOY_CHARS).slice(0, 10);
            let cells = shuffle([...TARGET_CHARS, ...decoys]);
            let doneSet = new Set();
            function renderRev() {
                let o = reversed.map((ch, i) => i < ci ? `<span class="done">${ch}</span>` : i === ci ? `<span class="current">${ch}</span>` : `<span class="remaining">${ch}</span>`).join(' ');
                render(`<div class="mini-label">üîÑ ÈÄÜÈ†Ü„Çø„ÉÉ„Éó</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„Çí<span class="highlight">ÈÄÜ„Åã„Çâ</span>„Çø„ÉÉ„ÉóÔºÅ<br><small>„ÅÑ‚Üí„Å™‚Üí„Åå‚Üí„Åç‚Üí„ÅÜ‚Üí„Åè</small></div><div class="order-display">${o}</div><div class="char-grid">${cells.map((c, i) => `<div class="char-cell ${doneSet.has(i) ? 'correct' : ''}" onclick="revTap(${i})">${c}</div>`).join('')}</div>${passButtonHTML()}`);
            }
            window.revTap = function(idx) {
                if (G.answered || doneSet.has(idx)) return;
                if (cells[idx] === reversed[ci]) { doneSet.add(idx); ci++; if (ci >= reversed.length) handleCorrect(); else renderRev(); }
                else handleWrong();
            };
            renderRev();
            startTimer(getTimeForRound() + 2000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†19: Ê∂àÁÅØ„Éë„Ç∫„É´ ======
        function miniGame_lightsOut() {
            G.miniType = 'üí° Ê∂àÁÅØ„Éë„Ç∫„É´'; updateHUD();
            let lights = [true, true, true, true, true, true];
            const clicks = 2 + Math.floor(Math.random() * 3);
            for (let i = 0; i < clicks; i++) {
                const idx = Math.floor(Math.random() * 6);
                lights[idx] = !lights[idx];
                if (idx > 0) lights[idx - 1] = !lights[idx - 1];
                if (idx < 5) lights[idx + 1] = !lights[idx + 1];
            }
            if (lights.every(l => !l)) { lights[0] = true; lights[1] = true; }
            window.lightTap = function(idx) {
                if (G.answered) return;
                lights[idx] = !lights[idx];
                if (idx > 0) lights[idx - 1] = !lights[idx - 1];
                if (idx < 5) lights[idx + 1] = !lights[idx + 1];
                renderLights();
                if (lights.every(l => !l)) handleCorrect();
            };
            function renderLights() {
                render(`<div class="mini-label">üí° Ê∂àÁÅØ„Éë„Ç∫„É´</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆÁÅØ„Çä„Çí<br>ÂÖ®ÈÉ®Ê∂à„ÅõÔºÅÔºàÈö£„ÇÇÂàá„ÇäÊõø„Çè„ÇãÔºâ</div><div style="display:flex;gap:6px;margin:20px 0;">${TARGET_CHARS.map((c, i) => `<div class="char-cell" onclick="lightTap(${i})" style="width:52px;height:60px;aspect-ratio:auto;font-size:1.5em;${lights[i] ? 'border-color:#ffcc00;background:linear-gradient(145deg,#443300,#332200);box-shadow:0 0 20px rgba(255,200,0,0.5);color:#ffcc00;' : 'border-color:#222;background:#111;color:#333;'}">${c}</div>`).join('')}</div>${passButtonHTML()}`);
            }
            renderLights();
            startTimer(getTimeForRound() + 4000, () => handleWrong());
        }

        // ====== „Éü„Éã„Ç≤„Éº„É†20: ÂΩ±ÊñáÂ≠ó„ÇØ„Ç§„Ç∫ ======
        function miniGame_shadow() {
            G.miniType = 'üë§ ÂΩ±ÊñáÂ≠ó„ÇØ„Ç§„Ç∫'; updateHUD();
            const idx = Math.floor(Math.random() * TARGET_CHARS.length);
            const correct = TARGET_CHARS[idx];
            const decoys = shuffle(DECOY_CHARS.filter(c => c !== correct)).slice(0, 3);
            const choices = shuffle([correct, ...decoys]);
            render(`<div class="mini-label">üë§ ÂΩ±ÊñáÂ≠ó„ÇØ„Ç§„Ç∫</div><div class="question-text">„Äå<em>„Åè„ÅÜ„Åç„Åå„Å™„ÅÑ</em>„Äç„ÅÆ${idx + 1}ÊñáÂ≠óÁõÆ<br>„Åº„ÇÑ„Åë„ÅüÊñáÂ≠ó„ÅØ‰ΩïÔºü</div><div style="font-size:5em;font-weight:900;color:#444;text-shadow:0 0 25px #6600ff;filter:blur(6px);margin:20px 0;pointer-events:none;">${correct}</div><div class="quiz-choices">${choices.map(c => `<button class="quiz-choice" onclick="shadowAnswer('${c}')">${c}</button>`).join('')}</div>${passButtonHTML()}`);
            window.shadowAnswer = function(ch) { if (G.answered) return; ch === correct ? handleCorrect() : handleWrong(); };
            startTimer(getTimeForRound(), () => handleWrong());
        }

        // ============================================================
        const miniGames = [
            miniGame_fillBlank, miniGame_findChar, miniGame_orderTap, miniGame_trueFalse,
            miniGame_bubbleTap, miniGame_quiz4, miniGame_fallCatch, miniGame_reflexTap,
            miniGame_swipe, miniGame_memory, miniGame_whackMole, miniGame_slot,
            miniGame_count, miniGame_typing, miniGame_spellCheck, miniGame_chainFind,
            miniGame_rapidTap, miniGame_reverse, miniGame_lightsOut, miniGame_shadow,
        ];

        function playRound() {
            let available = miniGames.filter((_, i) => i !== G.lastMiniIdx);
            if (available.length === 0) available = miniGames;
            const game = pick(available);
            G.lastMiniIdx = miniGames.indexOf(game);
            game();
        }

        // ========== ÁµêÊûúÁîªÈù¢ ==========
        function endGame() {
            stopTimer(); clearFallIntervals();

            const isCleared = G.round >= CLEAR_ROUND;
            const isNew = G.score > highScore;

            if (isNew) {
                highScore = G.score;
                localStorage.setItem('kuukiHighScore', highScore);
                document.getElementById('best-score').textContent = highScore.toLocaleString();
            }

            // ‚òÖ „ÇØ„É™„Ç¢„Å™„Çâ„Éï„É©„Ç∞‰øùÂ≠ò
            if (isCleared) {
                localStorage.setItem('gameClear_' + GAME_NUMBER, 'true');
            }

            const result = document.getElementById('result');
            const auroraEl = document.getElementById('result-aurora');

            if (isCleared) {
                result.className = 'screen clear-bg';
                auroraEl.className = 'result-aurora clear-aurora';
            } else {
                result.className = 'screen lose-bg';
                auroraEl.className = 'result-aurora lose-aurora';
            }

            document.getElementById('result-content').innerHTML = `
                ${isCleared ? '<div class="clear-badge">üéØ STAGE CLEAR!</div>' : ''}
                ${isNew && !isCleared ? '<div class="highscore-badge">üéâ NEW HIGH SCORE!</div>' : ''}
                ${isNew && isCleared ? '<div class="highscore-badge">üéâ NEW HIGH SCORE!</div>' : ''}
                <div class="result-icon-container">
                    <div class="icon-ring ${isCleared ? 'clear-ring' : ''}"></div>
                    <div class="result-icon">${isCleared ? 'üèÜ' : (isNew ? '‚≠ê' : 'ü´ß')}</div>
                </div>
                <div class="result-title ${isCleared ? 'title-clear' : 'title-lose'}">
                    ${isCleared ? 'GAME CLEAR!' : 'GAME OVER'}
                </div>
                <div class="result-score-box">
                    <div class="result-score-label">Total Score</div>
                    <div class="result-score-value" id="score-counter">0</div>
                </div>
                <div class="result-stats">
                    <div class="stat-row"><span>üéØ Âà∞ÈÅî„É©„Ç¶„É≥„Éâ</span><span class="stat-value ${isCleared ? 'green' : 'cyan'}">${G.round}</span></div>
                    <div class="stat-row"><span>üî• ÊúÄÂ§ß„Ç≥„É≥„Éú</span><span class="stat-value gold">${G.maxCombo}</span></div>
                    <div class="stat-row"><span>‚è≠ „Éë„Çπ‰ΩøÁî®</span><span class="stat-value gray">${G.passUsed} / ${G.maxPass}</span></div>
                    <div class="stat-row"><span>üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢</span><span class="stat-value pink">${highScore.toLocaleString()}</span></div>
                </div>
                ${isCleared ? `
                    <div class="result-buttons">
                        <button class="btn btn-green" onclick="goBack()">‚ú® „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å∏</button>
                        <button class="btn btn-cyan btn-small" onclick="startGame()">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                    </div>
                    <div class="redirect-msg">3ÁßíÂæå„Å´„É°„Éã„É•„Éº„Å∏Êàª„Çä„Åæ„Åô...</div>
                ` : `
                    <div class="result-buttons">
                        <button class="btn" onclick="startGame()">üîÑ RETRY</button>
                        <button class="btn btn-cyan btn-small" onclick="showScreen('title')">üè† TITLE</button>
                    </div>
                `}
            `;

            showScreen('result');

            // „Çπ„Ç≥„Ç¢„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            let cur = 0; const target = G.score, step = target / (1500/16);
            const counter = document.getElementById('score-counter');
            const cu = setInterval(() => {
                cur += step;
                if (cur >= target) { cur = target; clearInterval(cu); }
                counter.textContent = Math.floor(cur).toLocaleString();
            }, 16);

            // ÊºîÂá∫
            if (isCleared || isNew) {
                createConfetti();
                createStars();
            }

            // ‚òÖ „ÇØ„É™„Ç¢ÊôÇ„ÅØËá™Âãï„Åß„É°„Éã„É•„Éº„Å∏
            if (isCleared) {
                setTimeout(goBack, 3000);
            }
        }
    </script>
</body>
</html>