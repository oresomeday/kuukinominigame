<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ãã†ããŒãªã„ III - é¢¨ã®ç–¾èµ°</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
        body{font-family:'Hiragino Sans','Meiryo',sans-serif;background:#0a0a1a;min-height:100vh;overflow:hidden;touch-action:manipulation}
        .back-btn{position:fixed;top:15px;left:15px;background:linear-gradient(180deg,#004466,#006699);border:2px solid #00ceff;color:#fff;width:50px;height:50px;border-radius:50%;font-size:1.5rem;cursor:pointer;z-index:9999;box-shadow:0 4px 15px rgba(0,150,255,0.4);display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .back-btn:active{transform:scale(0.9)}
        #game{width:100vw;height:100vh;max-width:500px;margin:0 auto;position:relative;overflow:hidden}
        .screen{display:none;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;padding:15px;position:absolute;top:0;left:0}
        .screen.active{display:flex}
        #title{background:#000;position:relative;overflow:hidden}
        .bg-effects{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
        .cyber-grid{position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,rgba(0,206,255,0.03) 1px,transparent 1px),linear-gradient(rgba(0,206,255,0.03) 1px,transparent 1px);background-size:30px 30px;animation:gridMove 20s linear infinite}
        @keyframes gridMove{0%{background-position:0 0}100%{background-position:30px 30px}}
        .aurora{position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 20%,rgba(0,150,255,0.3) 0%,transparent 50%),radial-gradient(ellipse at 80% 30%,rgba(0,206,255,0.25) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(0,100,200,0.3) 0%,transparent 50%);animation:auroraShift 8s ease-in-out infinite}
        @keyframes auroraShift{0%,100%{opacity:.8}50%{opacity:1}}
        .particles{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden}
        .particle{position:absolute;border-radius:50%;animation:floatUp 10s infinite;opacity:0}
        @keyframes floatUp{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-100vh) scale(1);opacity:0}}
        .scanlines{position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent 0px,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px)}
        .title-content{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:20px}
        .title-logo{text-align:center;margin-bottom:auto;padding-top:12vh}
        .title-icon{font-size:4em;display:block;margin-bottom:15px;animation:iconFloat 3s ease-in-out infinite,iconGlow 2s ease-in-out infinite alternate}
        @keyframes iconFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
        @keyframes iconGlow{from{filter:drop-shadow(0 0 30px rgba(0,150,255,0.8))}to{filter:drop-shadow(0 0 50px rgba(0,206,255,0.8))}}
        .title-text{font-size:2.2em;font-weight:900;letter-spacing:.15em;color:#fff;text-shadow:0 0 10px #fff,0 0 20px #fff,0 0 40px #00ceff,0 0 80px #00ceff;animation:textPulse 2s ease-in-out infinite}
        @keyframes textPulse{0%,100%{text-shadow:0 0 10px #fff,0 0 20px #fff,0 0 40px #00ceff,0 0 80px #00ceff}50%{text-shadow:0 0 20px #fff,0 0 40px #fff,0 0 60px #0099ff,0 0 100px #0099ff}}
        .title-sub{font-size:.85em;color:#87ceeb;letter-spacing:.5em;margin-top:10px;text-shadow:0 0 20px #00ceff}
        .title-desc{color:#aaa;font-size:.85em;margin-top:15px;text-align:center;line-height:1.6}
        .title-desc span{color:#ff6688;font-weight:bold}
        .title-clear-info{color:#00ceff;font-size:.8em;margin-top:10px;padding:8px 16px;background:rgba(0,206,255,0.1);border:1px solid rgba(0,206,255,0.3);border-radius:20px}
        .start-btn-wrap{display:flex;align-items:center;justify-content:center}
        .start-btn{position:relative;background:transparent;border:none;padding:22px 70px;font-size:1.6em;font-weight:bold;color:#fff;cursor:pointer;text-transform:uppercase;letter-spacing:.1em;overflow:hidden;transition:all .3s}
        .start-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,#0066cc,#00ceff,#00e5ff,#0066cc);background-size:400% 400%;animation:gradShift 3s ease infinite;border-radius:50px;z-index:-2}
        @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .start-btn::after{content:'';position:absolute;inset:3px;background:rgba(0,0,0,.85);border-radius:47px;z-index:-1;transition:background .3s}
        .start-btn:hover::after,.start-btn:active::after{background:rgba(0,0,0,.6)}
        .start-btn span{position:relative;z-index:1;text-shadow:0 0 20px #fff}
        .start-btn:active{transform:scale(.95)}
        .deco-container{display:flex;align-items:center;gap:20px;margin-top:auto;padding-bottom:10vh}
        .deco-line{width:80px;height:2px;background:linear-gradient(90deg,transparent,#00ceff,#00e5ff,transparent);animation:lineGlow 2s infinite}
        @keyframes lineGlow{0%,100%{opacity:.5}50%{opacity:1}}
        .deco-diamond{width:12px;height:12px;background:linear-gradient(45deg,#00ceff,#00e5ff);transform:rotate(45deg);animation:dSpin 4s linear infinite;box-shadow:0 0 15px #00ceff}
        @keyframes dSpin{from{transform:rotate(45deg)}to{transform:rotate(405deg)}}
        .hud{position:absolute;top:0;left:0;right:0;padding:8px 12px;padding-left:70px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(0,0,0,.9) 0%,transparent 100%);z-index:10}
        .hud-item{display:flex;align-items:center;gap:5px;color:#fff;font-weight:bold}
        .lives{font-size:1.2em}
        .fever-gauge{width:80px;height:12px;background:#333;border-radius:6px;overflow:hidden;border:2px solid #666}
        .fever-fill{height:100%;background:linear-gradient(90deg,#0066cc,#00ceff,#00e5ff);background-size:200% 100%;animation:fgAnim 1s linear infinite;transition:width .3s}
        @keyframes fgAnim{0%{background-position:0% 0%}100%{background-position:200% 0%}}
        .score{color:#00ceff;font-size:1.1em;text-shadow:0 0 10px #00ceff}
        .combo-display{position:absolute;top:45px;right:15px;color:#ffff00;font-size:1.2em;font-weight:bold;text-shadow:0 0 15px #ffff00}
        .round-display{position:absolute;top:45px;left:70px;color:#00ff88;font-size:1em;font-weight:bold;text-shadow:0 0 10px #00ff88}
        .pass-display{position:absolute;top:70px;left:70px;color:#888;font-size:.9em;font-weight:bold}
        .mini-type{position:absolute;top:70px;right:15px;color:#87ceeb;font-size:.8em;font-weight:bold;text-shadow:0 0 10px #87ceeb}
        .clear-goal{position:absolute;top:95px;left:70px;color:#00ceff;font-size:.75em;font-weight:bold;text-shadow:0 0 8px #00ceff}
        .timer-wrap{position:absolute;top:40px;left:0;right:0;height:8px;background:rgba(255,255,255,.1)}
        .timer-bar{height:100%;background:linear-gradient(90deg,#00ff88,#00ceff);transition:width .05s linear;box-shadow:0 0 10px currentColor}
        .timer-bar.warn{background:linear-gradient(90deg,#ffcc00,#ff9900)}
        .timer-bar.danger{background:linear-gradient(90deg,#ff0044,#ff0088);animation:tPulse .2s infinite}
        @keyframes tPulse{0%,100%{opacity:1}50%{opacity:.6}}
        #gameplay{background:linear-gradient(180deg,#050a1a 0%,#0a1525 100%)}
        .game-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding-top:55px;position:relative}
        .fever-mode .game-area{animation:fBg .3s infinite alternate}
        @keyframes fBg{from{background:rgba(0,150,255,.12)}to{background:rgba(0,206,255,.12)}}
        .round-splash{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3em;font-weight:900;color:#fff;text-shadow:0 0 20px #fff,0 0 40px #00ceff,0 0 60px #00ceff;z-index:100;animation:splashA .6s forwards;text-align:center;white-space:nowrap}
        @keyframes splashA{0%{opacity:0;transform:translate(-50%,-50%) scale(3) rotate(-10deg)}40%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0)}100%{opacity:0;transform:translate(-50%,-50%) scale(.5)}}
        .popup{position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);font-size:2.5em;font-weight:bold;pointer-events:none;z-index:1000;animation:pAnim .5s forwards}
        @keyframes pAnim{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-80%) scale(1)}}
        .popup.nice{color:#00ff88;text-shadow:0 0 30px #00ff88}.popup.great{color:#00ceff;text-shadow:0 0 30px #00ceff}.popup.perfect{color:#00e5ff;text-shadow:0 0 30px #00e5ff}.popup.miss{color:#ff0044;text-shadow:0 0 30px #ff0044}.popup.pass{color:#888;text-shadow:0 0 30px #888}.popup.fever{color:#fff;text-shadow:0 0 30px #00ceff,0 0 60px #00e5ff;font-size:3em}
        .flash{position:fixed;inset:0;pointer-events:none;z-index:999}
        .flash.hit{animation:fG .15s}.flash.miss{animation:fR .15s}.flash.pass{animation:fGr .15s}
        @keyframes fG{from{background:rgba(0,255,100,.4)}to{background:transparent}}
        @keyframes fR{from{background:rgba(255,0,50,.4)}to{background:transparent}}
        @keyframes fGr{from{background:rgba(128,128,128,.3)}to{background:transparent}}
        .game-btn{padding:18px 40px;margin:8px;font-size:1.3em;font-weight:bold;border:none;border-radius:15px;cursor:pointer;transition:all .2s;text-shadow:0 2px 4px rgba(0,0,0,.3)}
        .game-btn:active{transform:scale(.95)}.game-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
        .btn-correct{background:linear-gradient(145deg,#00cc66,#009944);color:white;box-shadow:0 5px 20px rgba(0,200,100,.4)}
        .btn-wrong{background:linear-gradient(145deg,#ff4466,#cc2244);color:white;box-shadow:0 5px 20px rgba(255,50,100,.4)}
        .btn-pass{background:linear-gradient(145deg,#666,#444);color:#ddd;box-shadow:0 5px 20px rgba(100,100,100,.4);padding:12px 30px;font-size:1em}
        .btn-pass:disabled{background:linear-gradient(145deg,#333,#222);color:#555;box-shadow:none}
        .button-container{display:flex;flex-wrap:wrap;justify-content:center;margin-top:20px}
        .pass-container{margin-top:25px;text-align:center}
        .pass-remaining{color:#888;font-size:.9em;margin-top:8px}
        .question-text{color:#ccc;font-size:1.1em;text-align:center;margin-bottom:15px;line-height:1.5}
        .question-text em{color:#ffcc00;font-style:normal;font-weight:bold}
        .question-text .highlight{color:#00ceff;font-weight:bold;font-size:1.3em}
        .mini-label{color:#87ceeb;font-size:.85em;font-weight:bold;margin-bottom:8px;letter-spacing:.2em}
        .quiz-choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:320px;width:100%;margin-top:15px}
        .quiz-choice{padding:15px 10px;font-size:1.2em;font-weight:bold;border:2px solid #444;border-radius:12px;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);color:#fff;cursor:pointer;transition:all .15s;text-align:center}
        .quiz-choice:active{transform:scale(.95)}
        .quiz-choice.correct-answer{border-color:#00ff88;background:linear-gradient(145deg,#003322,#002211)}
        .quiz-choice.wrong-answer{border-color:#ff0044;background:linear-gradient(145deg,#330011,#220011)}
        .char-cell{display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:900;border-radius:12px;cursor:pointer;transition:all .15s;color:#fff;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);border:2px solid #444;box-shadow:0 4px 15px rgba(0,0,0,.3)}
        .char-cell:active{transform:scale(.9)}
        .char-cell.correct{border-color:#00ff88;background:linear-gradient(145deg,#003322,#002211)}
        .char-cell.wrong{border-color:#ff0044;background:linear-gradient(145deg,#330011,#220011);animation:cShake .3s}
        @keyframes cShake{25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

        /* ===== ã‚²ãƒ¼ãƒ å›ºæœ‰CSS ===== */
        .dice-display{font-size:5em;margin:15px 0;animation:diceRoll .4s ease-out;filter:drop-shadow(0 0 20px #00ceff)}
        @keyframes diceRoll{0%{transform:rotate(0) scale(.5);opacity:0}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1);opacity:1}}
        .spin-wheel{width:200px;height:200px;border-radius:50%;border:4px solid #00ceff;display:flex;align-items:center;justify-content:center;font-size:3.5em;font-weight:900;color:#fff;background:radial-gradient(circle,#1a2a3a,#0a1020);box-shadow:0 0 30px rgba(0,200,255,.3);margin:15px 0;transition:transform .05s}
        .spin-indicator{width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-top:20px solid #ff4466;margin-bottom:-5px}
        .vanish-row{display:flex;gap:8px;margin:15px 0;justify-content:center}
        .vanish-char{width:52px;height:60px;display:flex;align-items:center;justify-content:center;font-size:2em;font-weight:900;color:#fff;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);border:2px solid #00ceff;border-radius:10px;transition:all .5s}
        .vanish-char.gone{opacity:0;transform:scale(0);border-color:transparent}
        .drag-zone{width:100%;max-width:320px;display:flex;gap:5px;margin:15px 0;justify-content:center}
        .drag-slot{width:50px;height:58px;border:2px dashed #00ceff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:900;color:#00ceff;background:rgba(0,200,255,.05)}
        .drag-slot.filled{border-style:solid;color:#00ff88;border-color:#00ff88;background:rgba(0,255,100,.05)}
        .drag-pool{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:15px}
        .drag-item{width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:900;border:2px solid #555;border-radius:10px;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);color:#fff;cursor:pointer;transition:all .15s}
        .drag-item:active{transform:scale(.9);border-color:#00ceff}
        .drag-item.used{opacity:.3;pointer-events:none}
        .zoom-display{width:120px;height:120px;border-radius:15px;background:#111;border:3px solid #00ceff;display:flex;align-items:center;justify-content:center;font-size:8em;font-weight:900;color:#fff;overflow:hidden;margin:15px 0;box-shadow:0 0 25px rgba(0,200,255,.3)}
        .stroop-display{font-size:4em;font-weight:900;margin:20px 0;letter-spacing:.1em;text-shadow:none}
        .neighbor-pair{display:flex;gap:20px;margin:15px 0;align-items:center}
        .neighbor-char{width:80px;height:80px;display:flex;align-items:center;justify-content:center;font-size:2.5em;font-weight:900;color:#fff;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);border:2px solid #00ceff;border-radius:15px;box-shadow:0 0 15px rgba(0,200,255,.2)}
        .anagram-display{font-size:2.5em;font-weight:900;color:#fff;letter-spacing:.2em;margin:20px 0;text-shadow:0 0 20px #00ceff}
        .before-after-display{display:flex;gap:5px;margin:15px 0;align-items:center;font-size:2em;font-weight:900;color:#fff}
        .ba-char{padding:10px 15px;border:2px solid #00ceff;border-radius:10px;background:linear-gradient(145deg,#1a2a3a,#0a1a2a)}
        .ba-blank{padding:10px 15px;border:2px dashed #ffcc00;border-radius:10px;color:#ffcc00;animation:blinkB 1s infinite}
        @keyframes blinkB{0%,100%{border-color:#ffcc00}50%{border-color:transparent}}
        .roulette-container{position:relative;width:220px;height:220px;margin:15px auto}
        .roulette-wheel{width:100%;height:100%;border-radius:50%;border:4px solid #00ceff;position:relative;transition:transform .05s;box-shadow:0 0 30px rgba(0,200,255,.3)}
        .roulette-segment{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:900;color:#fff;pointer-events:none}
        .roulette-pointer{position:absolute;top:-15px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:18px solid #ff4466;z-index:5}
        .rapid-char{font-size:5em;font-weight:900;color:#fff;text-shadow:0 0 30px #00ceff;margin:10px 0;min-height:90px;display:flex;align-items:center;justify-content:center;animation:rapidFlash .15s}
        @keyframes rapidFlash{from{transform:scale(1.3);opacity:.5}to{transform:scale(1);opacity:1}}
        .chain-block{display:flex;gap:3px;margin:10px 0;flex-wrap:wrap;justify-content:center}
        .chain-b{width:40px;height:46px;display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:900;color:#fff;background:linear-gradient(145deg,#1a2a3a,#0a1a2a);border:2px solid #444;border-radius:6px}
        .chain-b.hl{border-color:#ffcc00;color:#ffcc00}

        /* ===== çµæœç”»é¢ ===== */
        #result{position:relative;overflow:hidden}
        #result.lose-bg{background:radial-gradient(ellipse at center,#0a1a2a 0%,#050a15 100%)}
        #result.clear-bg{background:radial-gradient(ellipse at center,#0a2530 0%,#051520 100%)}
        .result-aurora{position:absolute;top:0;left:0;right:0;bottom:0;animation:rAurora 3s ease-in-out infinite alternate}
        .result-aurora.lose-aurora{background:radial-gradient(ellipse at 30% 30%,rgba(0,100,200,.15) 0%,transparent 50%),radial-gradient(ellipse at 70% 70%,rgba(0,150,255,.15) 0%,transparent 50%)}
        .result-aurora.clear-aurora{background:radial-gradient(ellipse at 30% 30%,rgba(0,200,150,.25) 0%,transparent 50%),radial-gradient(ellipse at 70% 70%,rgba(0,206,255,.25) 0%,transparent 50%),radial-gradient(ellipse at 50% 50%,rgba(255,215,0,.15) 0%,transparent 50%)}
        @keyframes rAurora{from{opacity:.5}to{opacity:1}}
        .confetti-container{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none;z-index:1}
        .confetti{position:absolute;top:-20px;animation:cFall linear infinite}
        @keyframes cFall{0%{transform:translateY(-20px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(1080deg);opacity:.8}}
        .stars-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
        .star{position:absolute;font-size:1.5em;animation:sTwinkle 1s ease-out forwards}
        @keyframes sTwinkle{0%{transform:scale(0) rotate(0);opacity:1}50%{transform:scale(1.5) rotate(180deg)}100%{transform:scale(0) rotate(360deg);opacity:0}}
        .result-content{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center}
        .result-icon-container{position:relative;margin-bottom:20px}
        .result-icon{font-size:5em;animation:iEntry .8s cubic-bezier(.68,-.55,.265,1.55);filter:drop-shadow(0 0 30px currentColor)}
        @keyframes iEntry{0%{transform:scale(0) rotate(-180deg);opacity:0}100%{transform:scale(1) rotate(0);opacity:1}}
        .icon-ring{position:absolute;top:50%;left:50%;width:150px;height:150px;border:3px solid rgba(0,200,255,.3);border-radius:50%;transform:translate(-50%,-50%);animation:rExpand 1.5s ease-out infinite}
        .icon-ring.clear-ring{border-color:rgba(0,206,255,.4)}
        @keyframes rExpand{0%{width:100px;height:100px;opacity:1}100%{width:250px;height:250px;opacity:0}}
        .result-title{font-size:2.2em;font-weight:900;text-transform:uppercase;letter-spacing:.1em;margin-bottom:15px}
        .result-title.title-lose{color:#ff6688;text-shadow:0 0 20px #ff0044}
        .result-title.title-clear{color:#00ceff;text-shadow:0 0 20px #00ceff,0 0 40px #00ceff}
        .result-score-box{background:linear-gradient(135deg,rgba(0,0,0,.6),rgba(10,25,40,.6));border:2px solid rgba(0,200,255,.3);border-radius:20px;padding:20px 50px;margin:15px 0;text-align:center;backdrop-filter:blur(10px);box-shadow:0 0 30px rgba(0,200,255,.2);animation:bxAppear .5s ease-out .3s both}
        @keyframes bxAppear{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
        .result-score-label{color:#888;font-size:.9em;text-transform:uppercase;letter-spacing:.3em;margin-bottom:8px}
        .result-score-value{font-size:3em;font-weight:900;color:#00ceff;text-shadow:0 0 30px #00ceff;font-family:'Courier New',monospace}
        .result-stats{background:rgba(0,0,0,.4);border-radius:15px;padding:15px 25px;margin:10px 0;border:1px solid rgba(255,255,255,.1);animation:bxAppear .5s ease-out .5s both}
        .stat-row{display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:1em;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1);gap:30px}
        .stat-row:last-child{border-bottom:none}
        .stat-value{font-weight:bold;text-shadow:0 0 10px currentColor}
        .stat-value.cyan{color:#00ceff}.stat-value.gold{color:#ffd700}.stat-value.pink{color:#00e5ff}.stat-value.gray{color:#888}.stat-value.green{color:#00ff88}
        .result-buttons{display:flex;flex-direction:column;gap:10px;margin-top:20px;animation:bxAppear .5s ease-out .7s both}
        .btn{background:linear-gradient(145deg,#0077cc,#005599);color:white;border:none;padding:16px 45px;font-size:1.2em;font-weight:bold;border-radius:50px;cursor:pointer;box-shadow:0 5px 30px rgba(0,150,255,.5);transition:all .2s;position:relative;overflow:hidden;text-transform:uppercase;letter-spacing:.1em}
        .btn::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.3),transparent);transform:rotate(45deg);animation:bShine 2s infinite}
        @keyframes bShine{0%{left:-50%}100%{left:150%}}
        .btn:active{transform:scale(.95)}
        .btn-cyan{background:linear-gradient(145deg,#0088cc,#006699);box-shadow:0 5px 30px rgba(0,150,220,.5)}
        .btn-green{background:linear-gradient(145deg,#00aacc,#008899);box-shadow:0 5px 30px rgba(0,170,200,.5)}
        .btn-small{padding:12px 30px;font-size:1em}
        .highscore-badge{background:linear-gradient(145deg,#ffd700,#ff8800);color:#000;padding:8px 20px;border-radius:30px;font-weight:bold;font-size:1.1em;margin-bottom:15px;animation:badgePop .5s ease-out 1s both;box-shadow:0 0 30px rgba(255,215,0,.5)}
        @keyframes badgePop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
        .clear-badge{background:linear-gradient(145deg,#00ceff,#0099cc);color:#fff;padding:10px 25px;border-radius:30px;font-weight:bold;font-size:1.1em;margin-bottom:15px;animation:badgePop .5s ease-out .5s both;box-shadow:0 0 30px rgba(0,206,255,.5)}
        .redirect-msg{color:#00ceff;font-size:.85em;margin-top:15px;animation:blinkS 1.5s infinite}
        @keyframes blinkS{0%,100%{opacity:1}50%{opacity:.4}}
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">â†</button>
    <div id="game">
        <div class="flash" id="flash"></div>
        <div id="title" class="screen active">
            <div class="bg-effects"><div class="cyber-grid"></div><div class="aurora"></div><div class="particles" id="particles"></div><div class="scanlines"></div></div>
            <div class="title-content">
                <div class="title-logo">
                    <span class="title-icon">ğŸƒ</span>
                    <div class="title-text">ãã†ããŒãªã„</div>
                    <div class="title-sub">WIND SPRINT III</div>
                    <div class="title-desc">ã€Œ<span>ãã†ããŒãªã„</span>ã€ã«ã¾ã¤ã‚ã‚‹<br>ã•ã‚‰ãªã‚‹15ç¨®ã®æ–°ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ï¼</div>
                    <div class="title-clear-info">ğŸ¯ ROUND 15 åˆ°é”ã§ã‚¯ãƒªã‚¢ï¼</div>
                </div>
                <div class="start-btn-wrap"><button class="start-btn" onclick="startGame()"><span>â–¶ START</span></button></div>
                <div style="color:#00ceff;font-size:1.2em;text-shadow:0 0 15px #00ceff">ğŸ† BEST: <span id="best-score">0</span></div>
                <div class="deco-container"><div class="deco-line"></div><div class="deco-diamond"></div><div class="deco-line"></div></div>
            </div>
        </div>
        <div id="gameplay" class="screen">
            <div class="hud">
                <div class="hud-item"><span class="lives" id="lives">â¤ï¸â¤ï¸â¤ï¸</span></div>
                <div class="hud-item"><span style="font-size:.8em">ğŸ”¥</span><div class="fever-gauge"><div class="fever-fill" id="fever-fill" style="width:0%"></div></div></div>
                <div class="hud-item"><span class="score" id="score">0</span></div>
            </div>
            <div class="round-display" id="round-display">ROUND 1</div>
            <div class="pass-display" id="pass-display">â­ <span id="pass-icons">âšªâšªâšª</span></div>
            <div class="clear-goal" id="clear-goal">ğŸ¯ ã‚¯ãƒªã‚¢ã¾ã§: ã‚ã¨15</div>
            <div class="mini-type" id="mini-type"></div>
            <div class="combo-display" id="combo"></div>
            <div class="timer-wrap"><div class="timer-bar" id="timer"></div></div>
            <div class="game-area" id="area"></div>
        </div>
        <div id="result" class="screen">
            <div class="result-aurora" id="result-aurora"></div>
            <div class="confetti-container" id="confetti"></div>
            <div class="stars-container" id="stars"></div>
            <div class="result-content" id="result-content"></div>
        </div>
    </div>

<script>
const GAME_NUMBER=5,CLEAR_ROUND=15;
let highScore=parseInt(localStorage.getItem('kuuki3HighScore'))||0;
document.getElementById('best-score').textContent=highScore.toLocaleString();
function goBack(){window.location.href='index.html?menu=1';}

(function(){const c=document.getElementById('particles');for(let i=0;i<30;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.animationDelay=Math.random()*10+'s';p.style.animationDuration=(8+Math.random()*8)+'s';const s=2+Math.random()*5;p.style.width=s+'px';p.style.height=s+'px';const cols=['#00ceff','#0099ff','#00e5ff','#87ceeb','#4dc9f6'];const cl=cols[Math.floor(Math.random()*cols.length)];p.style.background=cl;p.style.boxShadow=`0 0 ${s*3}px ${cl}`;c.appendChild(p);}})();
function createConfetti(){const c=document.getElementById('confetti');c.innerHTML='';const sh=['â– ','â—','â–²','â˜…','â—†'];const co=['#00ceff','#00e5ff','#ffd700','#00ff88','#87ceeb','#ff8800'];for(let i=0;i<80;i++){const d=document.createElement('div');d.className='confetti';d.textContent=sh[Math.floor(Math.random()*sh.length)];d.style.left=Math.random()*100+'%';d.style.color=co[Math.floor(Math.random()*co.length)];d.style.fontSize=(10+Math.random()*12)+'px';d.style.animationDuration=(2+Math.random()*3)+'s';d.style.animationDelay=Math.random()*2+'s';d.style.textShadow=`0 0 10px ${d.style.color}`;c.appendChild(d);}}
function createStars(){const c=document.getElementById('stars');c.innerHTML='';for(let i=0;i<20;i++){setTimeout(()=>{const s=document.createElement('div');s.className='star';s.textContent='âœ¦';s.style.left=Math.random()*100+'%';s.style.top=Math.random()*100+'%';s.style.color=['#ffd700','#fff','#00ceff'][Math.floor(Math.random()*3)];c.appendChild(s);setTimeout(()=>s.remove(),1000);},i*200);}}

let G={round:0,lives:3,score:0,combo:0,maxCombo:0,fever:0,isFever:false,timer:null,timeLeft:0,baseTime:6000,passUsed:0,maxPass:3,answered:false,miniType:'',fallIntervals:[],lastMiniIdx:-1};
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.getElementById('gameplay').classList.remove('fever-mode');}
function render(h){document.getElementById('area').innerHTML=h;}
function showSplash(t,cb,d=500){render(`<div class="round-splash">${t}</div>`);setTimeout(cb,d);}
function updateHUD(){document.getElementById('lives').textContent='â¤ï¸'.repeat(G.lives)+'ğŸ–¤'.repeat(3-G.lives);document.getElementById('score').textContent=G.score.toLocaleString();document.getElementById('combo').textContent=G.combo>1?`${G.combo}ã‚³ãƒ³ãƒœ!`:'';document.getElementById('fever-fill').style.width=`${Math.min(G.fever,100)}%`;document.getElementById('round-display').textContent=`ROUND ${G.round}`;document.getElementById('pass-icons').textContent='âšª'.repeat(G.maxPass-G.passUsed)+'âš«'.repeat(G.passUsed);document.getElementById('mini-type').textContent=G.miniType;const r=Math.max(0,CLEAR_ROUND-G.round);const g=document.getElementById('clear-goal');if(G.round>=CLEAR_ROUND){g.textContent='âœ… ã‚¯ãƒªã‚¢æ¡ä»¶é”æˆï¼';g.style.color='#ffd700';}else g.textContent=`ğŸ¯ ã‚¯ãƒªã‚¢ã¾ã§: ã‚ã¨${r+1}`;}
function getTime(){return Math.max(2500,G.baseTime-(G.round-1)*80);}
function startTimer(t,cb){clearInterval(G.timer);G.timeLeft=t;const b=document.getElementById('timer');b.style.width='100%';b.className='timer-bar';G.timer=setInterval(()=>{G.timeLeft-=30;const p=G.timeLeft/t*100;b.style.width=p+'%';if(p<25)b.className='timer-bar danger';else if(p<50)b.className='timer-bar warn';if(G.timeLeft<=0){clearInterval(G.timer);if(cb)cb();}},30);}
function stopTimer(){clearInterval(G.timer);}
function clearFI(){G.fallIntervals.forEach(id=>{clearInterval(id);clearTimeout(id);});G.fallIntervals=[];}
function startGame(){G.round=0;G.lives=3;G.score=0;G.combo=0;G.maxCombo=0;G.fever=0;G.isFever=false;G.passUsed=0;G.answered=false;G.miniType='';G.lastMiniIdx=-1;showScreen('gameplay');showSplash('ğŸƒ READY',()=>showSplash('GO!',nextRound,300),400);}
function nextRound(){if(G.lives<=0)return endGame();G.round++;G.answered=false;clearFI();updateHUD();if(G.fever>=100&&!G.isFever){G.isFever=true;document.getElementById('gameplay').classList.add('fever-mode');popup('ğŸ”¥ FEVER! ğŸ”¥','fever');}if(G.round===CLEAR_ROUND)showSplash('ğŸ¯ CLEARæ¡ä»¶é”æˆ!',playRound,600);else if(G.round%10===1&&G.round>1)showSplash(`ğŸ”¥ ROUND ${G.round}!`,playRound,500);else playRound();}
function handleCorrect(){if(G.answered)return;G.answered=true;stopTimer();clearFI();G.combo++;if(G.combo>G.maxCombo)G.maxCombo=G.combo;const m=G.isFever?2:1;const p=(100+G.combo*25)*m;G.score+=p;G.fever=Math.min(G.fever+15,100);flash('hit');if(G.combo>=10)popup('ğŸŒŸ AMAZING!','perfect');else if(G.combo>=5)popup('ğŸ”¥ PERFECT!','perfect');else if(G.combo>=3)popup('GREAT!','great');else popup(`+${p}`,'nice');updateHUD();setTimeout(nextRound,400);}
function handleWrong(){if(G.answered)return;G.answered=true;stopTimer();clearFI();G.lives--;G.combo=0;G.fever=Math.max(G.fever-30,0);G.isFever=false;document.getElementById('gameplay').classList.remove('fever-mode');flash('miss');popup('MISS...','miss');updateHUD();setTimeout(()=>{if(G.lives<=0)endGame();else nextRound();},500);}
function handlePass(){if(G.answered||G.passUsed>=G.maxPass)return;G.answered=true;stopTimer();clearFI();G.passUsed++;G.combo=0;G.fever=Math.max(G.fever-10,0);flash('pass');popup('PASS','pass');updateHUD();setTimeout(nextRound,300);}
function popup(t,ty){const p=document.createElement('div');p.className=`popup ${ty}`;p.textContent=t;document.body.appendChild(p);setTimeout(()=>p.remove(),600);}
function flash(ty){const f=document.getElementById('flash');f.className='flash '+ty;setTimeout(()=>f.className='flash',200);}
function shuffle(a){const r=[...a];for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];}return r;}
function pick(a){return a[Math.floor(Math.random()*a.length)];}
function passHTML(){const r=G.maxPass-G.passUsed;return`<div class="pass-container"><button class="game-btn btn-pass" onclick="handlePass()" ${r<=0?'disabled':''}>â­ ãƒ‘ã‚¹</button><div class="pass-remaining">æ®‹ã‚Š ${r} å›</div></div>`;}

const T='ãã†ããŒãªã„';
const TC=['ã','ã†','ã','ãŒ','ãª','ã„'];
const DC=['ã‘','ãŠ','ã‹','ã','ã¬','ãˆ','ã“','ã‚','ã•','ã—','ã™','ã›','ã','ãŸ','ã¡','ã¤','ã¦','ã¨','ã«','ã®','ã¯','ã²','ãµ','ã¸','ã»','ã¾','ã¿','ã‚€','ã‚','ã‚‚','ã‚„','ã‚†','ã‚ˆ','ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚','ã‚','ã‚’','ã‚“','ã”','ã','ã’','ã–','ãš','ãœ','ã','ã ','ã§','ã©'];

// ====== 1. ã‚µã‚¤ã‚³ãƒ­ä½ç½® ======
function mg_dice(){
    G.miniType='ğŸ² ã‚µã‚¤ã‚³ãƒ­';updateHUD();
    const num=1+Math.floor(Math.random()*6);
    const correct=TC[num-1];
    const diceEmoji=['','âš€','âš','âš‚','âšƒ','âš„','âš…'][num];
    const decoys=shuffle(DC.filter(c=>c!==correct)).slice(0,3);
    const choices=shuffle([correct,...decoys]);
    window._diceAns=function(ch){if(G.answered)return;ch===correct?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ² ã‚µã‚¤ã‚³ãƒ­</div><div class="question-text">ã‚µã‚¤ã‚³ãƒ­ã®ç›®ãŒç¤ºã™<br>ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®æ–‡å­—ã¯ï¼Ÿ</div><div class="dice-display">${diceEmoji}</div><div style="color:#888;font-size:1em;margin-bottom:10px">${num}ç•ªç›®ã®æ–‡å­—</div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_diceAns('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 2. ã‚¹ãƒ”ãƒŠãƒ¼ ======
function mg_spinner(){
    G.miniType='ğŸŒ€ ã‚¹ãƒ”ãƒŠãƒ¼';updateHUD();
    const allC=shuffle([...TC,...DC.slice(0,6)]);
    let idx=0,spinning=true,speed=3;
    const ti=setInterval(()=>{
        if(!spinning||G.answered){clearInterval(ti);return;}
        idx=(idx+1)%allC.length;
        const w=document.getElementById('spinW');if(w)w.textContent=allC[idx];
    },60+Math.random()*40);
    G.fallIntervals.push(ti);
    window._spinStop=function(){
        if(G.answered||!spinning)return;spinning=false;clearInterval(ti);
        const ch=allC[idx];
        if(TC.includes(ch))handleCorrect();else handleWrong();
    };
    render(`<div class="mini-label">ğŸŒ€ ã‚¹ãƒ”ãƒŠãƒ¼</div><div class="question-text">ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®æ–‡å­—ã§æ­¢ã‚ã‚ï¼</div><div class="spin-indicator"></div><div class="spin-wheel" id="spinW">${allC[0]}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_spinStop()" style="font-size:1.5em;padding:20px 60px">â¹ STOP</button></div>${passHTML()}`);
    startTimer(getTime()+2000,()=>{clearInterval(ti);if(!G.answered)handleWrong();});
}

// ====== 3. æ¶ˆå¤±é † ======
function mg_vanishOrder(){
    G.miniType='ğŸ‘» æ¶ˆå¤±é †';updateHUD();
    const order=shuffle([0,1,2,3,4,5]);
    let step=0;
    const vanishSpeed=Math.max(400,800-G.round*20);
    // Show all, then vanish one by one
    function doVanish(){
        if(step>=6||G.answered)return;
        const el=document.getElementById('vn-'+order[step]);
        if(el)el.classList.add('gone');
        step++;
        if(step<6){const tid=setTimeout(doVanish,vanishSpeed);G.fallIntervals.push(tid);}
        else{
            const askN=1+Math.floor(Math.random()*3);// ask which vanished 1st, 2nd, or 3rd
            const correct=TC[order[askN-1]];
            const decoys=shuffle(TC.filter(c=>c!==correct)).slice(0,3);
            const choices=shuffle([correct,...decoys]);
            window._vnAns=function(ch){if(G.answered)return;ch===correct?handleCorrect():handleWrong();};
            const tid2=setTimeout(()=>{
                render(`<div class="mini-label">ğŸ‘» æ¶ˆå¤±é †</div><div class="question-text">${askN}ç•ªç›®ã«æ¶ˆãˆãŸæ–‡å­—ã¯ï¼Ÿ<br><small style="color:#666">ã€Œãã†ããŒãªã„ã€ã®ã©ã®æ–‡å­—ï¼Ÿ</small></div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_vnAns('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
                startTimer(getTime(),()=>handleWrong());
            },500);
            G.fallIntervals.push(tid2);
        }
    }
    render(`<div class="mini-label">ğŸ‘» æ¶ˆå¤±é †</div><div class="question-text">æ–‡å­—ãŒæ¶ˆãˆã‚‹é †ç•ªã‚’è¦šãˆã‚ï¼</div><div class="vanish-row">${TC.map((c,i)=>`<div class="vanish-char" id="vn-${i}">${c}</div>`).join('')}</div>`);
    const st=setTimeout(doVanish,1000);G.fallIntervals.push(st);
}

// ====== 4. ãƒ‰ãƒ©ãƒƒã‚°é…ç½® ======
function mg_dragPlace(){
    G.miniType='ğŸ§² é…ç½®ãƒ‘ã‚ºãƒ«';updateHUD();
    const blankCount=Math.min(2+Math.floor(G.round/8),4);
    const blankIdxs=shuffle([0,1,2,3,4,5]).slice(0,blankCount).sort((a,b)=>a-b);
    let filled={},currentSlot=0;
    const answers=blankIdxs.map(i=>TC[i]);
    const decoys=shuffle(DC).slice(0,Math.max(2,4-blankCount));
    const pool=shuffle([...answers,...decoys]);
    function renderDrag(){
        const slotsHTML=TC.map((c,i)=>{
            if(blankIdxs.includes(i)){
                return`<div class="drag-slot ${filled[i]?'filled':''}">${filled[i]||'?'}</div>`;
            }
            return`<div class="drag-slot filled" style="border-color:#00ceff;color:#fff">${c}</div>`;
        }).join('');
        const poolHTML=pool.map((c,i)=>{
            const used=Object.values(filled).includes(c)&&pool.filter(x=>x===c).length<=Object.values(filled).filter(x=>x===c).length;
            return`<div class="drag-item ${used?'used':''}" onclick="_dragPick('${c}')">${c}</div>`;
        }).join('');
        render(`<div class="mini-label">ğŸ§² é…ç½®ãƒ‘ã‚ºãƒ«</div><div class="question-text">ç©ºæ¬„ã«æ­£ã—ã„æ–‡å­—ã‚’å…¥ã‚Œã¦<br>ã€Œ<em>ãã†ããŒãªã„</em>ã€ã‚’å®Œæˆã•ã›ã‚ˆã†ï¼</div><div class="drag-zone">${slotsHTML}</div><div class="drag-pool">${poolHTML}</div>${passHTML()}`);
    }
    window._dragPick=function(ch){
        if(G.answered)return;
        const targetIdx=blankIdxs[currentSlot];
        if(ch===TC[targetIdx]){filled[targetIdx]=ch;currentSlot++;if(currentSlot>=blankIdxs.length)handleCorrect();else renderDrag();}
        else handleWrong();
    };
    renderDrag();
    startTimer(getTime()+blankCount*800,()=>handleWrong());
}

// ====== 5. è¶…ã‚ºãƒ¼ãƒ  ======
function mg_superZoom(){
    G.miniType='ğŸ” è¶…ã‚ºãƒ¼ãƒ ';updateHUD();
    const idx=Math.floor(Math.random()*TC.length);const correct=TC[idx];
    const offX=-20+Math.random()*10;const offY=-10+Math.random()*10;
    const decoys=shuffle(DC.filter(c=>c!==correct)).slice(0,3);
    const choices=shuffle([correct,...decoys]);
    window._zoomAns=function(ch){if(G.answered)return;ch===correct?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ” è¶…ã‚ºãƒ¼ãƒ </div><div class="question-text">æ‹¡å¤§ã•ã‚ŒãŸã€Œ<em>ãã†ããŒãªã„</em>ã€ã®æ–‡å­—ã¯ï¼Ÿ</div><div class="zoom-display"><span style="transform:translate(${offX}px,${offY}px)">${correct}</span></div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_zoomAns('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 6. ã‚¹ãƒˆãƒ«ãƒ¼ãƒ— ======
function mg_stroop(){
    G.miniType='ğŸŒˆ è‰²æ–‡å­—';updateHUD();
    const colorNames=[{name:'ã‚ã‹',css:'#ff4444'},{name:'ã‚ãŠ',css:'#4488ff'},{name:'ã¿ã©ã‚Š',css:'#44cc44'},{name:'ãã„ã‚',css:'#ffcc00'},{name:'ã‚€ã‚‰ã•ã',css:'#cc44ff'}];
    const mode=Math.random()<0.5;// true: ask about character, false: ask about color
    const charIdx=Math.floor(Math.random()*TC.length);const ch=TC[charIdx];
    const colorIdx=Math.floor(Math.random()*colorNames.length);const color=colorNames[colorIdx];
    if(mode){
        // Is the displayed CHARACTER part of ãã†ããŒãªã„?
        const isTarget=Math.random()<0.5;
        const displayCh=isTarget?ch:pick(DC);
        window._stroopAns=function(a){if(G.answered)return;a===isTarget?handleCorrect():handleWrong();};
        render(`<div class="mini-label">ğŸŒˆ è‰²æ–‡å­—</div><div class="question-text">è‰²ã«æƒ‘ã‚ã•ã‚Œã‚‹ãªï¼<br>ã“ã®<span class="highlight">æ–‡å­—</span>ã¯ã€Œ<em>ãã†ããŒãªã„</em>ã€ã«å«ã¾ã‚Œã‚‹ï¼Ÿ</div><div class="stroop-display" style="color:${color.css}">${displayCh}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_stroopAns(true)" style="padding:16px 45px;font-size:1.3em">â­• YES</button><button class="game-btn btn-wrong" onclick="_stroopAns(false)" style="padding:16px 45px;font-size:1.3em">âœ– NO</button></div>${passHTML()}`);
    }else{
        // What color is the text displayed in?
        const displayCh=pick(TC);
        const correct=color.name;
        const decoys=shuffle(colorNames.filter(c=>c.name!==correct)).slice(0,3).map(c=>c.name);
        const choices=shuffle([correct,...decoys]);
        window._stroopAns2=function(name){if(G.answered)return;name===correct?handleCorrect():handleWrong();};
        render(`<div class="mini-label">ğŸŒˆ è‰²æ–‡å­—</div><div class="question-text">ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®æ–‡å­—ã®<br><span class="highlight">è‰²</span>ã¯ä½•è‰²ï¼Ÿ</div><div class="stroop-display" style="color:${color.css}">${displayCh}</div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_stroopAns2('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
    }
    startTimer(getTime(),()=>handleWrong());
}

// ====== 7. éš£æ¥åˆ¤å®š ======
function mg_neighbor(){
    G.miniType='ğŸ”— éš£æ¥åˆ¤å®š';updateHUD();
    let a,b;
    const isAdj=Math.random()<0.5;
    if(isAdj){
        a=Math.floor(Math.random()*5);b=a+1;
    }else{
        do{a=Math.floor(Math.random()*6);b=Math.floor(Math.random()*6);}while(Math.abs(a-b)<=1||a===b);
    }
    if(Math.random()<0.5)[a,b]=[b,a];
    window._nbrAns=function(ans){if(G.answered)return;ans===isAdj?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ”— éš£æ¥åˆ¤å®š</div><div class="question-text">ã“ã®2æ–‡å­—ã¯ã€Œ<em>ãã†ããŒãªã„</em>ã€ã§<br><span class="highlight">éš£ã‚Šåˆã£ã¦ã„ã‚‹</span>ï¼Ÿ</div><div class="neighbor-pair"><div class="neighbor-char">${TC[a]}</div><div style="color:#555;font-size:1.5em">âŸ·</div><div class="neighbor-char">${TC[b]}</div></div><div class="button-container"><button class="game-btn btn-correct" onclick="_nbrAns(true)" style="padding:16px 40px;font-size:1.3em">â­• éš£</button><button class="game-btn btn-wrong" onclick="_nbrAns(false)" style="padding:16px 40px;font-size:1.3em">âœ– é›¢ã‚Œã¦ã‚‹</button></div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 8. ã‚¢ãƒŠã‚°ãƒ©ãƒ åˆ¤å®š ======
function mg_anagram(){
    G.miniType='ğŸ”  ã‚¢ãƒŠã‚°ãƒ©ãƒ ';updateHUD();
    const isCorrect=Math.random()<0.45;
    let display;
    if(isCorrect){
        display=shuffle([...TC]).join('');
    }else{
        const modified=[...TC];
        const ri=Math.floor(Math.random()*6);
        modified[ri]=pick(DC);
        display=shuffle(modified).join('');
    }
    window._anaAns=function(ans){if(G.answered)return;ans===isCorrect?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ”  ã‚¢ãƒŠã‚°ãƒ©ãƒ </div><div class="question-text">ã“ã‚Œã¯ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®<br>ã‚¢ãƒŠã‚°ãƒ©ãƒ ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ï¼Ÿ</div><div class="anagram-display">${display}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_anaAns(true)" style="padding:16px 40px;font-size:1.3em">â­• YES</button><button class="game-btn btn-wrong" onclick="_anaAns(false)" style="padding:16px 40px;font-size:1.3em">âœ– NO</button></div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 9. å‰å¾Œå•é¡Œ ======
function mg_beforeAfter(){
    G.miniType='â†”ï¸ å‰å¾Œå•é¡Œ';updateHUD();
    const isBefore=Math.random()<0.5;
    let targetIdx;
    if(isBefore){targetIdx=1+Math.floor(Math.random()*5);}// 1-5 (has a char before)
    else{targetIdx=Math.floor(Math.random()*5);}// 0-4 (has a char after)
    const answerIdx=isBefore?targetIdx-1:targetIdx+1;
    const correct=TC[answerIdx];
    const decoys=shuffle(DC.filter(c=>c!==correct)).slice(0,3);
    const choices=shuffle([correct,...decoys]);
    window._baAns=function(ch){if(G.answered)return;ch===correct?handleCorrect():handleWrong();};
    const dirText=isBefore?'å‰':'å¾Œ';
    const arrow=isBefore?'â†':'â†’';
    render(`<div class="mini-label">â†”ï¸ å‰å¾Œå•é¡Œ</div><div class="question-text">ã€Œ<em>ãã†ããŒãªã„</em>ã€ã§<br>ã€Œ<span class="highlight">${TC[targetIdx]}</span>ã€ã®${dirText}ã®æ–‡å­—ã¯ï¼Ÿ</div><div class="before-after-display">${isBefore?`<div class="ba-blank">?</div><div style="color:#555">${arrow}</div><div class="ba-char">${TC[targetIdx]}</div>`:`<div class="ba-char">${TC[targetIdx]}</div><div style="color:#555">${arrow}</div><div class="ba-blank">?</div>`}</div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_baAns('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 10. é€Ÿèª­ã‚«ã‚¦ãƒ³ãƒˆ ======
function mg_rapidCount(){
    G.miniType='â© é€Ÿèª­ã‚«ã‚¦ãƒ³ãƒˆ';updateHUD();
    const tc=pick(TC);
    const seqLen=8+Math.min(Math.floor(G.round/3),8);
    const allC=[...TC,...DC.slice(0,6)];
    let seq=[];let correctCount=0;
    for(let i=0;i<seqLen;i++){
        const ch=Math.random()<0.3?tc:pick(allC.filter(c=>c!==tc));
        if(ch===tc)correctCount++;
        seq.push(ch);
    }
    if(correctCount===0){seq[Math.floor(Math.random()*seqLen)]=tc;correctCount=1;}
    let idx=0;
    const flashSpeed=Math.max(200,400-G.round*10);
    function showNext(){
        if(idx>=seqLen||G.answered)return askAnswer();
        const el=document.getElementById('rapidCh');
        if(el){el.textContent=seq[idx];el.style.animation='none';el.offsetHeight;el.style.animation='rapidFlash .15s';}
        idx++;
        const tid=setTimeout(showNext,flashSpeed);G.fallIntervals.push(tid);
    }
    function askAnswer(){
        if(G.answered)return;
        const opts=[correctCount];while(opts.length<4){const v=correctCount+Math.floor(Math.random()*5)-2;if(v>=0&&!opts.includes(v))opts.push(v);}
        const choices=shuffle(opts);
        window._rcAns=function(v){if(G.answered)return;v===correctCount?handleCorrect():handleWrong();};
        render(`<div class="mini-label">â© é€Ÿèª­ã‚«ã‚¦ãƒ³ãƒˆ</div><div class="question-text">ã€Œ<span class="highlight">${tc}</span>ã€ã¯ä½•å›å‡ºãŸï¼Ÿ<br><small style="color:#666">ã€Œãã†ããŒãªã„ã€ã®æ–‡å­—ã‚’æ•°ãˆãŸ</small></div><div class="quiz-choices">${choices.map(v=>`<button class="quiz-choice" onclick="_rcAns(${v})">${v}å›</button>`).join('')}</div>${passHTML()}`);
        startTimer(getTime(),()=>handleWrong());
    }
    render(`<div class="mini-label">â© é€Ÿèª­ã‚«ã‚¦ãƒ³ãƒˆ</div><div class="question-text">ã€Œ<span class="highlight">${tc}</span>ã€ãŒä½•å›å‡ºã‚‹ã‹æ•°ãˆã‚ï¼</div><div class="rapid-char" id="rapidCh">...</div>`);
    const st=setTimeout(showNext,500);G.fallIntervals.push(st);
}

// ====== 11. ãƒŸãƒ©ãƒ¼åˆ¤å®š ======
function mg_mirror(){
    G.miniType='ğŸª ãƒŸãƒ©ãƒ¼åˆ¤å®š';updateHUD();
    const isReversed=Math.random()<0.5;
    const display=isReversed?[...TC].reverse().join(''):T;
    // Add some wrong variants
    const variants=[
        {text:[...TC].reverse().join(''),isRev:true},
        {text:T,isRev:false},
    ];
    const v=isReversed?variants[0]:variants[1];
    window._mirAns=function(ans){if(G.answered)return;ans===v.isRev?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸª ãƒŸãƒ©ãƒ¼åˆ¤å®š</div><div class="question-text">ã“ã®è¡¨ç¤ºã¯ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®<br><span class="highlight">é€†ã•èª­ã¿</span>ï¼Ÿ</div><div class="anagram-display">${v.text}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_mirAns(true)" style="padding:16px 40px;font-size:1.3em">â­• é€†ã•ã </button><button class="game-btn btn-wrong" onclick="_mirAns(false)" style="padding:16px 40px;font-size:1.3em">âœ– é•ã†</button></div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 12. äºŒæŠãƒ©ãƒƒã‚·ãƒ¥ ======
function mg_binaryRush(){
    G.miniType='âš¡ äºŒæŠãƒ©ãƒƒã‚·ãƒ¥';updateHUD();
    const types=[
        ()=>{const c=pick([...TC,...DC.slice(0,6)]);const isIn=TC.includes(c);return{q:`ã€Œ${c}ã€ã¯å«ã¾ã‚Œã‚‹ï¼Ÿ`,a:isIn};},
        ()=>{const i=Math.floor(Math.random()*6);const c=pick([...TC,...DC.slice(0,3)]);const correct=TC[i]===c;return{q:`${i+1}æ–‡å­—ç›®ã¯ã€Œ${c}ã€ï¼Ÿ`,a:correct};},
        ()=>{const len=Math.random()<0.5?6:5;return{q:`æ–‡å­—æ•°ã¯${len}ï¼Ÿ`,a:len===6};},
        ()=>{const c=pick(TC);const i=TC.indexOf(c);const half=Math.random()<0.5?'å‰åŠ':'å¾ŒåŠ';const isCorrect=half==='å‰åŠ'?i<3:i>=3;return{q:`ã€Œ${c}ã€ã¯${half}ï¼Ÿ`,a:isCorrect};},
    ];
    const q=pick(types)();
    window._brAns=function(a){if(G.answered)return;a===q.a?handleCorrect():handleWrong();};
    render(`<div class="mini-label">âš¡ äºŒæŠãƒ©ãƒƒã‚·ãƒ¥</div><div class="question-text" style="font-size:1.2em;margin:25px 0">ã€Œ<em>ãã†ããŒãªã„</em>ã€ã«ã¤ã„ã¦<br>${q.q}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_brAns(true)" style="font-size:1.8em;padding:20px 50px">â­•</button><button class="game-btn btn-wrong" onclick="_brAns(false)" style="font-size:1.8em;padding:20px 50px">âœ–</button></div>${passHTML()}`);
    startTimer(getTime()-500,()=>handleWrong());
}

// ====== 13. ç©´åŸ‹ã‚æ–‡ ======
function mg_sentenceFill(){
    G.miniType='ğŸ“ ç©´åŸ‹ã‚æ–‡';updateHUD();
    const sentences=[
        {s:'ï¼¿ã†ããŒãªã„',a:'ã',pos:0},
        {s:'ãï¼¿ããŒãªã„',a:'ã†',pos:1},
        {s:'ãã†ï¼¿ãŒãªã„',a:'ã',pos:2},
        {s:'ãã†ãï¼¿ãªã„',a:'ãŒ',pos:3},
        {s:'ãã†ããŒï¼¿ã„',a:'ãª',pos:4},
        {s:'ãã†ããŒãªï¼¿',a:'ã„',pos:5},
    ];
    const q=pick(sentences);
    const decoys=shuffle(DC.filter(c=>c!==q.a)).slice(0,3);
    const choices=shuffle([q.a,...decoys]);
    window._sfAns=function(ch){if(G.answered)return;ch===q.a?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ“ ç©´åŸ‹ã‚æ–‡</div><div class="question-text">ï¼¿ã«å…¥ã‚‹æ–‡å­—ã¯ï¼Ÿ</div><div style="font-size:2.5em;font-weight:900;color:#fff;letter-spacing:.15em;margin:20px 0;text-shadow:0 0 20px #00ceff">${q.s}</div><div class="quiz-choices">${choices.map(c=>`<button class="quiz-choice" onclick="_sfAns('${c}')">${c}</button>`).join('')}</div>${passHTML()}`);
    startTimer(getTime(),()=>handleWrong());
}

// ====== 14. é€£é–ãƒã‚¤ãƒ©ã‚¤ãƒˆ ======
function mg_chainHighlight(){
    G.miniType='ğŸ”¦ é€£é–HL';updateHUD();
    const before=1+Math.floor(Math.random()*3);
    const after=1+Math.floor(Math.random()*3);
    let chain=[];
    for(let i=0;i<before;i++)chain.push(pick(DC));
    const start=chain.length;
    chain.push(...TC);
    for(let i=0;i<after;i++)chain.push(pick(DC));
    // Highlight a random segment and ask if it's part of ãã†ããŒãªã„
    const hlStart=Math.floor(Math.random()*(chain.length-2));
    const hlLen=2+Math.floor(Math.random()*2);
    const hlEnd=Math.min(hlStart+hlLen,chain.length);
    // Check if highlighted segment is entirely within the target word
    const isWithin=hlStart>=start&&hlEnd<=start+6;
    window._chAns=function(a){if(G.answered)return;a===isWithin?handleCorrect():handleWrong();};
    render(`<div class="mini-label">ğŸ”¦ é€£é–HL</div><div class="question-text">ãƒã‚¤ãƒ©ã‚¤ãƒˆéƒ¨åˆ†ã¯<br>ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®ä¸€éƒ¨ï¼Ÿ</div><div class="chain-block">${chain.map((c,i)=>`<div class="chain-b ${i>=hlStart&&i<hlEnd?'hl':''}">${c}</div>`).join('')}</div><div class="button-container"><button class="game-btn btn-correct" onclick="_chAns(true)" style="padding:16px 40px;font-size:1.3em">â­• ãã†</button><button class="game-btn btn-wrong" onclick="_chAns(false)" style="padding:16px 40px;font-size:1.3em">âœ– é•ã†</button></div>${passHTML()}`);
    startTimer(getTime()+500,()=>handleWrong());
}

// ====== 15. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ======
function mg_roulette(){
    G.miniType='ğŸ¡ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ';updateHUD();
    const allC=shuffle([...TC,...DC.slice(0,6)]);
    const segCount=allC.length;
    let angle=0,spinning=true,speed=8+Math.random()*4;
    const decel=0.97-Math.random()*0.01;
    function spin(){
        if(!spinning||G.answered)return;
        angle+=speed;speed*=decel;
        const w=document.getElementById('rWheel');
        if(w)w.style.transform=`rotate(${angle}deg)`;
        if(speed<0.3){spinning=false;
            const segAngle=360/segCount;
            const normAngle=((angle%360)+360)%360;
            const idx=Math.floor(normAngle/segAngle)%segCount;
            const selected=allC[(segCount-idx)%segCount];
            if(TC.includes(selected))handleCorrect();else handleWrong();
            return;
        }
        requestAnimationFrame(spin);
    }
    // Build visual - simplified: show current character in center
    let displayIdx=0;
    const di=setInterval(()=>{
        if(!spinning||G.answered){clearInterval(di);return;}
        const segAngle=360/segCount;
        const normAngle=((angle%360)+360)%360;
        displayIdx=Math.floor(normAngle/segAngle)%segCount;
        const ch=allC[(segCount-displayIdx)%segCount];
        const disp=document.getElementById('rDisp');
        if(disp){disp.textContent=ch;disp.style.color=TC.includes(ch)?'#00ff88':'#ff4466';}
    },50);
    G.fallIntervals.push(di);
    render(`<div class="mini-label">ğŸ¡ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</div><div class="question-text">ã€Œ<em>ãã†ããŒãªã„</em>ã€ã®æ–‡å­—ã§<br>æ­¢ã¾ã‚Œã°ã‚¯ãƒªã‚¢ï¼</div><div class="roulette-container"><div class="roulette-pointer"></div><div class="roulette-wheel" id="rWheel"><div class="roulette-segment" id="rDisp" style="font-size:2.5em">${allC[0]}</div></div></div><div style="color:#888;font-size:.9em;margin:10px 0">è‡ªå‹•ã§æ¸›é€Ÿã—ã¾ã™...</div>${passHTML()}`);
    requestAnimationFrame(spin);
    startTimer(getTime()+4000,()=>{if(!G.answered)handleWrong();});
}

// ============================================================
const miniGames=[mg_dice,mg_spinner,mg_vanishOrder,mg_dragPlace,mg_superZoom,mg_stroop,mg_neighbor,mg_anagram,mg_beforeAfter,mg_rapidCount,mg_mirror,mg_binaryRush,mg_sentenceFill,mg_chainHighlight,mg_roulette];

function playRound(){
    let avail=miniGames.filter((_,i)=>i!==G.lastMiniIdx);
    if(!avail.length)avail=miniGames;
    const g=pick(avail);G.lastMiniIdx=miniGames.indexOf(g);g();
}

function endGame(){
    stopTimer();clearFI();
    const isCleared=G.round>=CLEAR_ROUND;const isNew=G.score>highScore;
    if(isNew){highScore=G.score;localStorage.setItem('kuuki3HighScore',highScore);document.getElementById('best-score').textContent=highScore.toLocaleString();}
    if(isCleared)localStorage.setItem('gameClear_'+GAME_NUMBER,'true');
    const r=document.getElementById('result');const au=document.getElementById('result-aurora');
    if(isCleared){r.className='screen clear-bg';au.className='result-aurora clear-aurora';}else{r.className='screen lose-bg';au.className='result-aurora lose-aurora';}
    document.getElementById('result-content').innerHTML=`
        ${isCleared?'<div class="clear-badge">ğŸ¯ STAGE CLEAR!</div>':''}
        ${isNew?'<div class="highscore-badge">ğŸ‰ NEW HIGH SCORE!</div>':''}
        <div class="result-icon-container"><div class="icon-ring ${isCleared?'clear-ring':''}"></div><div class="result-icon">${isCleared?'ğŸ†':(isNew?'â­':'ğŸƒ')}</div></div>
        <div class="result-title ${isCleared?'title-clear':'title-lose'}">${isCleared?'GAME CLEAR!':'GAME OVER'}</div>
        <div class="result-score-box"><div class="result-score-label">Total Score</div><div class="result-score-value" id="score-counter">0</div></div>
        <div class="result-stats">
            <div class="stat-row"><span>ğŸ¯ åˆ°é”ãƒ©ã‚¦ãƒ³ãƒ‰</span><span class="stat-value ${isCleared?'green':'cyan'}">${G.round}</span></div>
            <div class="stat-row"><span>ğŸ”¥ æœ€å¤§ã‚³ãƒ³ãƒœ</span><span class="stat-value gold">${G.maxCombo}</span></div>
            <div class="stat-row"><span>â­ ãƒ‘ã‚¹ä½¿ç”¨</span><span class="stat-value gray">${G.passUsed}/${G.maxPass}</span></div>
            <div class="stat-row"><span>ğŸ† ãƒã‚¤ã‚¹ã‚³ã‚¢</span><span class="stat-value pink">${highScore.toLocaleString()}</span></div>
        </div>
        ${isCleared?`<div class="result-buttons"><button class="btn btn-green" onclick="goBack()">âœ¨ ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã¸</button><button class="btn btn-cyan btn-small" onclick="startGame()">ğŸ”„ ã‚‚ã†ä¸€åº¦</button></div><div class="redirect-msg">3ç§’å¾Œã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚Šã¾ã™...</div>`:`<div class="result-buttons"><button class="btn" onclick="startGame()">ğŸ”„ RETRY</button><button class="btn btn-cyan btn-small" onclick="showScreen('title')">ğŸ  TITLE</button></div>`}`;
    showScreen('result');
    let cur=0;const target=G.score,step=target/(1500/16);const counter=document.getElementById('score-counter');
    const cu=setInterval(()=>{cur+=step;if(cur>=target){cur=target;clearInterval(cu);}counter.textContent=Math.floor(cur).toLocaleString();},16);
    if(isCleared||isNew){createConfetti();createStars();}
    if(isCleared)setTimeout(goBack,3000);
}
</script>
</body>
</html>